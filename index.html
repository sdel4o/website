<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><title>Master Catalog & Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, minimum-scale=0.8, user-scalable=yes">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<script src="shipping_config.js"></script>
<style>
/* ============ GLOBAL STYLES ============ */
body { font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0px 20px; }
h1 { text-align: center; font-size: 1.7em; line-height: 1.0; margin-top: 20px; margin-bottom: 20px; font-weight: 600; }

/* ============ FOR HER/FOR HIM BUTTONS ============ */
.gender-tabs-container {
    display: flex;
    margin-bottom: 10px;
    gap: 40px; /* 10 spaces between buttons */
    justify-content: flex-start;
}

.gender-tab {
    background: none;
    border: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.1em;
    font-weight: 500;
    cursor: pointer;
    padding: 8px 0;
    position: relative;
    transition: all 0.3s ease;
    color: rgba(255, 215, 0, 0.6); /* muted gold/gray for inactive */
}

.gender-tab:hover {
    color: rgba(255, 215, 0, 0.8); /* slightly brighter on hover */
}

.gender-tab.active {
    font-weight: 600;
    color: #FFD700; /* bright gold for active */
}

.gender-underline {
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 100%;
    height: 4px;
    background: #FFD700;
    border-radius: 2px;
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.gender-tab.active .gender-underline {
    transform: scaleX(1);
}

/* Mobile portrait: For Her left, For Him right */
@media (max-width: 768px) and (orientation: portrait) {
    .gender-tabs-container {
        justify-content: space-between;
        gap: 0;
        margin-bottom: 8px;
    }
    
    .gender-tab {
        font-size: 1em;
        padding: 6px 0;
    }
}

/* Mobile landscape: same as desktop */
@media (max-width: 768px) and (orientation: landscape) {
    .gender-tabs-container {
        justify-content: flex-start;
        gap: 40px;
    }
}

/* ============ CUSTOM FILTER SELECTOR STYLES ============ */
.custom-select-wrapper {
    position: relative;
    width: 100%;
    z-index: 1000;
    justify-self: center !important;
}

.select-placeholder {
    text-align: center !important;
    display: block !important;
    margin: 0 auto !important;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
    border: 2px solid #D4AF37;
    border-radius: 30px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    color: #FFD700;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 44px;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

.custom-select-trigger:hover {
    border-color: #FFD700;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
}

.custom-select-trigger.active {
    border-color: #FFD700;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
}

.select-placeholder {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

.select-arrow {
    font-size: 0.8em;
    margin-left: 10px;
    color: #D4AF37;
    transition: transform 0.3s ease;
    flex-shrink: 0;
}

.custom-select-trigger.active .select-arrow {
    transform: rotate(180deg);
}

/* DESKTOP CUSTOM SELECT DROPDOWN (default for all devices) */
.custom-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    width: 100%;
    max-height: 300px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    border: 2px solid #D4AF37;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 1001;
    margin-top: 5px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin; 
}

/* Webkit browsers (Chrome, Safari, Edge) scrollbar styling */
.custom-select-dropdown::-webkit-scrollbar {
    width: 8px; /* Width of the scrollbar */
}

.custom-select-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.custom-select-header {
    display: none; /* Hidden for desktop */
}

.custom-select-close {
    display: none; /* Hidden for desktop */
}

.custom-select-option {
    padding: 8px 20px;
    text-align: left;
    border: none;
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    transition: all 0.2s ease;
    background: transparent;
    color: #FFD700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.custom-select-option:last-child {
    border-bottom: none;
}

.custom-select-option:hover {
    background: rgba(212, 175, 55, 0.15);
    color: #FFD700;
}

.custom-select-option.selected {
    background: #D4AF37;
    color: #000;
    font-weight: 600;
}

/* NO OVERLAY FOR DESKTOP */
.custom-select-overlay {
    display: none !important;
}

/* ============ MOBILE CUSTOM SELECT (Portrait only) ============ */
@media (max-width: 768px) and (orientation: portrait) {
    .custom-select-trigger {
        padding: 10px 14px !important;
        font-size: 0.85em !important;
        min-height: 40px;
    }

    .custom-select-wrapper:has(.custom-select-dropdown.active) {
        z-index: 1010 !important;
    }

    /* CHANGE THIS: Use desktop-like dropdown instead of bottom sheet */
    .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 250px;
        background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
        border: 2px solid #D4AF37;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        z-index: 1011 !important;
        margin-top: 5px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        scrollbar-width: thin;
    }
    
    .size-picker-dropdown::-webkit-scrollbar {
        width: 5px; /* Even thinner on mobile */
    }

    .custom-select-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    /* Remove mobile-only elements */
    .custom-select-header {
        display: none !important;
    }
    
    .custom-select-close {
        display: none !important;
    }
    
    .custom-select-options {
        padding: 8px 0;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .custom-select-option {
        padding: 12px 20px;
        text-align: left;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    /* Remove overlay for mobile too */
    .custom-select-overlay {
        display: none !important;
    }
    
    /* Keep the options visible in DOM */
    .custom-select-options {
        display: block;
        flex-direction: column;
        gap: 0;
    }
}

/* ============ LANDSCAPE MOBILE ============ */
@media (max-width: 768px) and (orientation: landscape) {
    /* Use desktop styles for landscape (no overlay, no bottom sheet) */
    .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: auto;
        width: 100%;
        max-height: 200px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        margin-top: 5px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        scrollbar-width: thin; 
        z-index: 10021 !important;
    }

    .custom-select-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .custom-select-header {
        display: none;
    }
    
    .custom-select-close {
        display: none;
    }
    
    .custom-select-options {
        flex-direction: column;
        gap: 0;
        display: flex;
    }
    
    .custom-select-option {
        padding: 10px 16px;
        text-align: left;
        border: none;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        margin: 0;
    }
    
    .custom-select-overlay {
        display: none !important;
    }
}


/* ============ SIZE PICKER STYLES - DESKTOP FIRST APPROACH ============ */
.size-picker {
    position: relative;
    width: 100%;
    max-width: 95px;
}

.size-picker-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 0.80em;
    font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #555;
    min-width: 60px;
    transition: border-color 0.2s ease;
}

.size-picker-trigger:hover {
    border-color: #aaa;
}

.size-placeholder {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.8em;
}

.size-arrow {
    font-size: 0.8em;
    margin-left: 5px;
    color: #777;
}

/* DESKTOP SIZE PICKER DROPDOWN (default for all devices) */
.size-picker-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: auto;
    top: auto;
    width: 120px;
    max-height: 300px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 10000;
    margin-bottom: 5px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    display: block; /* Always visible in DOM */
    overflow-y: auto;
}

.size-picker-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.size-picker-header {
    display: none; /* Hidden for desktop */
}

.size-picker-close {
    display: none; /* Hidden for desktop */
}

.size-picker-options {
    padding: 8px 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    max-height: 300px;
    overflow-y: auto;
}

.size-option {
    padding: 10px 16px;
    text-align: left;
    border: none;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    transition: all 0.2s ease;
    background: white;
}

.size-option:last-child {
    border-bottom: none;
}

.size-option:hover {
    background: #f8f9fa;
}

.size-option.selected {
    background: #000;
    color: white;
    border-color: #000;
    font-weight: 600;
}

/* NO OVERLAY FOR DESKTOP */
.size-overlay {
    display: none !important;
}

/* ============ MOBILE SIZE PICKER (Portrait only) ============ */
@media (max-width: 768px) and (orientation: portrait) {
    .size-picker-trigger {
        font-size: 0.8em !important;
        padding: 5px 6px !important; /* determines width of size picker box */
        min-width: 60px !important;
        box-sizing: border-box !important;  /* Add this line */
    }

    .size-picker-dropdown {
        /* MOBILE-ONLY STYLES */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        width: 100%;
        max-height: 70vh;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        margin: 0;
        transform: translateY(100%);
        opacity: 1;
        visibility: visible;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .size-picker-dropdown.active {
        transform: translateY(0);
    }
    
    .size-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        font-weight: 600;
        font-size: 1em;
        color: #333;
        position: sticky;
        top: 0;
        background: white;
        z-index: 2;
    }
    
    .size-picker-close {
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        font-size: 1.2em;
        color: #777;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
    }
    
    .size-picker-close:hover {
        background: #f5f5f5;
    }
    
    .size-picker-options {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 2px;
        padding: 10px 0;
        max-height: calc(70vh - 70px);
        display: grid;
    }
    
    .size-option {
        padding: 12px 8px;
        text-align: center;
        border: 1px solid #eee;
        border-radius: 8px;
        margin: 0 10px;
        border-bottom: 1px solid #eee;
    }
    
    /* MOBILE OVERLAY */
    .size-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .size-overlay.active {
        opacity: 1;
        visibility: visible;
    }
}

/* ============ LANDSCAPE MOBILE SIZE PICKER ============ */
@media (max-width: 768px) and (orientation: landscape) {
    /* Use desktop styles for landscape (no overlay, no bottom sheet) */
    .size-picker-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: auto;
        top: auto;
        width: 120px;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        margin-bottom: 5px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .size-picker-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .size-picker-header {
        display: none;
    }
    
    .size-picker-close {
        display: none;
    }
    
    .size-picker-options {
        flex-direction: column;
        gap: 0;
        display: flex;
    }
    
    .size-option {
        padding: 10px 16px;
        text-align: left;
        border: none;
        border-bottom: 1px solid #f5f5f5;
        margin: 0;
    }
    
    .size-overlay {
        display: none !important;
    }
}

/* ============ UPDATED FILTER CONTROLS - Desktop Layout / Desktop CSS ============ */

/* Controls container should match catalog width */
.controls {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
    padding: 15px 20px;
    border-radius: 12px; 
    margin: 0 auto 20px; /* Center it */
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border: 1.8px solid #D4AF37;
    position: relative;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%; /* Match catalog width */
    max-width: 1600px; /* Higher limit for large screens */
    box-sizing: border-box;
}

/* Search bar - FROM OLD CODE */
#searchInput {
    width: 100%;
    padding: 14px 20px;
    border: 2px solid #D4AF37;
    border-radius: 30px;
    background: #000;
    color: #FFD700;
    font-family: 'Montserrat', sans-serif;
    font-size: 1em;
    font-weight: 500;
    transition: all 0.3s ease;
    box-sizing: border-box;
    margin-bottom: 8px;
}

#searchInput:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
    border-color: #FFD700;
}

#searchInput::placeholder {
    color: #999;
}

/* Top row - All filters in one dynamic grid */
.filter-top-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 10x;
}

/* Bottom row - Clear Filters left, Sort button right */
.filter-bottom-row {
    display: flex;
    justify-content: space-between; /* Clear left, Sort right */
    align-items: center;
    gap: 10px;
    margin-top: 5px;
    padding-top: 10px;
    border-top: 1px solid rgba(212, 175, 55, 0.3);
}

/* Clear Filters button (left) */
.clear-filters-container {
    flex-shrink: 0;
}

/* Sort button in bottom row (right) */
.sort-button-container {
    flex-shrink: 0;
}

/* Filter Buttons - FROM NEW CODE */
.filter-btn {
    width: 100%;
    padding: 12px 18px;
    border: 2px solid #D4AF37;
    border-radius: 30px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    color: #FFD700;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Cart Button - FROM OLD CODE (size and position) */
.cart-summary-btn {
    position: absolute;
    right: 25px;
    top: 82.5px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    color: #FFD700;
    border: 2px solid #D4AF37;
    padding: 12px 25px;
    border-radius: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.9em;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.cart-summary-btn:hover {
    background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
    color: #000;
    border-color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(212, 175, 55, 0.4);
}

.cart-icon {
    font-size: 1.2em;
}

.cart-text {
    display: inline;
}

.cart-count {
    background: #D4AF37;
    color: #000;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8em;
}

/* ============ CART NOTIFICATION STYLES ============ */
.cart-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    color: #FFD700;
    border: 2px solid #D4AF37;
    padding: 15px 25px;
    border-radius: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.9em;
    z-index: 10000;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.cart-notification.show {
    opacity: 1;
    transform: translateY(0);
}

.cart-notification.hide {
    opacity: 0;
    transform: translateY(-20px);
}

.cart-notification-icon {
    font-size: 1.2em;
}

/* Mobile responsive notification */
@media (max-width: 768px) {
    .cart-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
        padding: 12px 20px;
    }
}

/* ============ ELEGANT ALERT STYLES ============ */
.elegant-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(8px);
}

.elegant-alert-box {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #D4AF37;
    border-radius: 20px;
    padding: 5px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    animation: slideIn 0.3s ease-out;
    margin: 0 auto;
}

@keyframes slideIn {
    from { transform: translateY(-30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.elegant-alert-icon {
    font-size: 60px;
    margin-bottom: 10px;
    color: #D4AF37;
    text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
}

.elegant-alert-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.4em;
    font-weight: 600;
    color: #FFD700;
    margin-bottom: 15px;
}

.elegant-alert-message {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95em;
    color: #ccc;
    line-height: 1.5;
    margin-bottom: 20px;
}

.elegant-alert-btn {
    background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
    color: #000;
    border: none;
    padding: 14px 30px;
    border-radius: 30px;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 250px;
    margin: 0 auto 20px auto;
    display: block;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.elegant-alert-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
}

/* Enhanced Error (showerror) Styling */
.input-error {
    border-color: #ff4d4d !important;
    background-color: #fff5f5 !important;
}

.input-error:focus {
    border-color: #ff1a1a !important;
    box-shadow: 0 0 0 3px rgba(255, 77, 77, 0.1) !important;
}

.error-message {
    color: #ff4d4d;
    font-size: 12px;
    margin-top: 5px;
    text-align: left;
    font-weight: 500;
}


/* ============ MODERN CUSTOM DROPDOWN STYLES ============ */
.gold-select {
    width: 100%;
    padding: 12px 18px;
    border: 2px solid #D4AF37;
    box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.3);
    border-radius: 30px;
    background: #000;
    color: #FFD700;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9em;
    font-weight: 500;
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23D4AF37'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 20px center;
    background-size: 20px;
    padding-right: 50px;
    box-sizing: border-box;
}

.gold-select:focus {
    outline: none;
    border-color: #FFD700;
}

.gold-select option {
    background: #000;
    color: #FFD700;
    border: 1px solid #D4AF37;
}

/* ============ SIMPLE MOBILE OPTIMIZATION - Mobile CSS ============ */
/* ============ MOBILE OPTIMIZATION (Portrait Phones Only) ============ */
@media (max-width: 768px) and (orientation: portrait) {
    /* Performance optimizations */
    .product-card {
        will-change: transform;
        contain: content;
    }
    
    .catalog-container {
        contain: layout style paint;
    }
    
    /* Disable hover effects on mobile for better performance */
    .product-card:hover, .qty-btn:hover, .catalog-qty-btn:hover {
        transform: none !important;
        box-shadow: none !important;
        transition: none !important;
    }
    
    .gold-select, .filter-btn, .cart-summary-btn, .qty-btn, .catalog-qty-btn {
        -webkit-tap-highlight-color: transparent !important; /* Remove blue tap highlight */
        touch-action: manipulation !important;
    }
    .filter-btn {
        -webkit-tap-highlight-color: transparent !important;
        touch-action: manipulation !important;
    }

    body {
        zoom: 1 !important;
        -moz-transform: none !important;
        transform: none !important;
        width: 100% !important;
        min-height: 100vh !important;
        padding: 0 10px 15px !important;
        margin: 0 !important;
        overflow-x: hidden !important;
        position: static !important;
        left: 0 !important;
        font-size: 14px; /* Base font size for mobile */
    }
    
    /* Scale down headings */
    h1 {
        font-size: 1.3em !important;
        line-height: 1.2 !important;
        margin-top: 15px !important;
        margin-bottom: 15px !important;
        padding: 0 5px !important;
    }
    
    /* FIX 1: Controls - Keep original styling but scale down */
    .controls {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
        padding: 12px !important;
        border-radius: 10px !important;
        margin: 0 auto 15px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
        border: 1.8px solid #D4AF37 !important;
        position: relative !important;
        z-index: 100 !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        font-size: 0.9em !important;
    }
    
    /* FIX 2: Search Bar - Smaller but proportional */
    #searchInput {
        width: 100% !important;
        margin: 0 0 12px 0 !important;
        padding: 12px 18px !important;
        border: 2px solid #D4AF37 !important;
        border-radius: 30px !important;
        background: #000 !important;
        color: #FFD700 !important;
        font-family: 'Montserrat', sans-serif !important;
        font-size: 0.95em !important;
        font-weight: 500 !important;
        box-sizing: border-box !important;
        display: block !important;
    }
    
    /* FIX 3: Cart Button - Keep original position */
    .cart-summary-btn {
        position: absolute !important;
        right: 25px !important;
        top: 78px !important;
        background: linear-gradient(135deg, #000 0%, #2d2d2d 100%) !important;
        color: #FFD700 !important;
        border: 2px solid #D4AF37 !important;
        padding: 8px 18px !important;
        border-radius: 30px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        font-family: 'Montserrat', sans-serif !important;
        font-weight: 600 !important;
        font-size: 0.85em !important;
        text-decoration: none !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
        margin: 0 !important;
        z-index: 101 !important;
    }
    
    /* FIX 4: Filter grid - Keep 2 columns */
    .filter-top-row {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
        width: 100% !important;
        margin: 0 0 8px 0 !important;
        box-sizing: border-box !important;
    }
    
    /* FIX 5: Filter selects - Smaller */
    .custom-select-trigger {
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 10px 12px !important;
        margin: 0 !important;
        border: 2px solid #D4AF37 !important;
        border-radius: 30px !important;
        background: linear-gradient(135deg, #000 0%, #2d2d2d 100%) !important;
        color: #FFD700 !important;
        font-family: 'Montserrat', sans-serif !important;
        font-size: 0.85em !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        min-height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }
    
    #subBrandFilter[style*="inline-block"] + * + * + * + #genFilter {
        grid-column: 1 !important;
        justify-self: start !important;
    }
    
    /* FIX 7: Sort button row */
    .filter-bottom-row {
        width: 100% !important;
        margin: 8px 0 0 0 !important;
        padding-top: 8px !important;
        border-top: 1px solid rgba(212, 175, 55, 0.3) !important;
        display: flex !important;
        justify-content: space-between !important; /* Clear left, Sort right */
        align-items: center !important;
    }
    
    .clear-filters-container,
    .sort-button-container {
        width: 48% !important; /* Both buttons take ~half width */
    }
    
    .clear-filters-container .filter-btn,
    .sort-button-container .filter-btn {
        width: 100% !important;
        padding: 10px 16px !important;
        margin: 0 !important;
        border: 2px solid #D4AF37 !important;
        border-radius: 30px !important;
        background: linear-gradient(135deg, #000 0%, #2d2d2d 100%) !important;
        color: #FFD700 !important;
        font-family: 'Montserrat', sans-serif !important;
        font-size: 0.85em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 6px !important;
    }
    
    /* FIX 8: Catalog container - Ensure 2 columns fit perfectly */
    .catalog-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
        padding: 0 2px !important;
    }
    
    /* FIX 9: Product card - Smaller but proportional */
    .product-card {
        padding: 8px !important;
        border-radius: 8px !important;
        font-size: 0.9em !important;
    }
    
    .main-image img {
        height: 180px !important; /* Smaller height to fit 2 cards */
        object-fit: contain !important;
    }
    
    .product-name {
        font-size: 0.6em !important;
        min-height: 2em !important;
        margin: 6px 0 4px !important;
        line-height: 1.2 !important;
    }
    
    .product-price {
        font-size: 0.75em !important;
    }
    
    .thumbnails {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 3px !important;
    }
    
    .thumbnail-img {
        height: 32px !important;
    }
    
    /* FIX 11: Add button - Smaller */
    .product-info button {
        padding: 4px 10px !important;
        font-size: 0.65em !important;
    }
    
    /* FIX 12: Quantity controls - Smaller */
    .catalog-qty-controls {
        gap: 3px !important;
        padding: 3px !important;
    }
    
    .catalog-qty-btn {
        padding: 2px 6px !important;
        font-size: 0.75em !important;
        min-width: 24px !important;
        background: #f0f0f0 !important;
        border: 1px solid #ddd !important;
        border-radius: 3px !important;
        font-weight: bold !important;
        cursor: pointer !important;
    }
    .catalog-qty-btn:hover {
        background: #e5e5e5 !important;
    }
    
    /* FIX 13: Notification - Proper positioning (NO transform) */
    .cart-notification {
        top: 80px !important; /* Below cart button */
        right: 20px !important;
        left: 20px !important;
        text-align: center !important;
        padding: 12px 18px !important;
        transform: none !important;
        z-index: 10000 !important;
        font-size: 0.9em !important;
    }
    
    /* FIX 14: Image modal - Proper positioning (NO transform) */
    #imageModal[style*="display: block"] {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    #modalImg {
        max-width: 75% !important;
        max-height: 70vh !important;
    }
    #nextBtn {
    right: 1% !important; 
    }
    #prevBtn {
    left: 1% !important; 
    }
   .modal-arrows {
    /* fixes mobile touch */
    z-index: 10007 !important;
    -webkit-tap-highlight-color: transparent !important;
    touch-action: manipulation !important;
    cursor: pointer !important;
    user-select: none !important;
    outline: none !important;
    position: relative;
    }
    /* FIX 15: Elegant alert - Proper positioning */
    .elegant-alert-overlay {
        transform: none !important;
        width: 100% !important;
        left: 0 !important;
        padding: 0 20px !important;
        box-sizing: border-box !important;
    }
    
    .elegant-alert-box {
        max-width: 90% !important;
        padding: 20px !important;
    }
    
    /* FIX 16: Checkout modal - Proper positioning */
    #checkoutModal {
        transform: none !important;
        width: 100% !important;
        left: 0 !important;
    }
    
    .checkout-modal-content {
        width: 95% !important;
        margin: 5% auto !important;
    }
}
    /* FIX 16: Checkout modal - Proper positioning */
    #checkoutModal {
        transform: none !important;
        width: 100% !important;
        left: 0 !important;
    }
    
    .checkout-modal-content {
        width: 95% !important;
        margin: 5% auto !important;
    }
    
    /* ===== ADD THIS NEW FIX 17 SECTION HERE ===== */
    /* FIX 17: Checkout quantity controls - Match catalog styling */
    .qty-controls {
        gap: 3px !important;
    }
    
    .qty-btn {
        padding: 2px 6px !important;
        font-size: 0.75em !important;
        min-width: 24px !important;
        background: #f0f0f0 !important;
        border: 1px solid #ddd !important;
        border-radius: 3px !important;
        font-weight: bold !important;
        cursor: pointer !important;
    }
    
    .qty-btn:hover {
        background: #e5e5e5 !important;
    }
    
    .cart-item .item-meta {
        font-size: 0.7em !important;
    }
    
    .cart-item img {
        width: 50px !important;
        height: 50px !important;
    }
    
    .cart-item {
        padding: 10px 0 !important;
    }
    /* ===== END OF NEW FIX 17 ===== */

/* Small phones */
@media (max-width: 375px) and (orientation: portrait) {
    .product-card:hover, .qty-btn:hover, .catalog-qty-btn:hover {
        transform: none !important;
        box-shadow: none !important;
    }
    .gold-select, .filter-btn, .cart-summary-btn, .qty-btn, .catalog-qty-btn {
        touch-action: manipulation !important;
    }
    body {
        padding: 0 8px 15px !important;
        font-size: 13px !important;
    }
    
    h1 {
        font-size: 1.2em !important;
        margin-top: 12px !important;
    }
    
    .controls {
        padding: 10px !important;
    }
    
    .cart-summary-btn {
        right: 10px !important;
        top: 78px !important;
        padding: 7px 15px !important;
        font-size: 0.8em !important;
    }
    
    #searchInput {
        padding: 10px 15px !important;
        font-size: 0.9em !important;
        margin-bottom: 10px !important;
    }
    
    .custom-select-trigger {
        padding: 8px 10px !important;
        font-size: 0.8em !important;
    }
    
    .clear-filters-container .filter-btn,
    .sort-button-container .filter-btn {
        padding: 8px 14px !important;
        font-size: 0.8em !important;
    }
    
    .catalog-container {
        gap: 8px !important;
    }
    
    .main-image img {
        height: 160px !important;
    }
    
    .cart-notification {
        top: 70px !important;
        right: 15px !important;
        left: 15px !important;
        padding: 10px 15px !important;
        font-size: 0.85em !important;
    }
    
    /* ===== ADDED THIS TO SMALL PHONES SECTION ===== */
    .catalog-qty-btn {
        padding: 1px 5px !important;
        font-size: 0.7em !important;
        min-width: 22px !important;
    }
    
    .qty-btn {
        padding: 1px 5px !important;
        font-size: 0.7em !important;
        min-width: 22px !important;
    }
    
    .cart-item img {
        width: 45px !important;
        height: 45px !important;
    }
    /* ===== END OF ADDITION ===== */
}

/* ============ MOBILE LANDSCAPE ============ */
@media (max-width: 768px) and (orientation: landscape) {
    /* Keep desktop-like layout in landscape */
    body {
        zoom: 1 !important;
        transform: none !important;
        width: 100% !important;
        padding: 0 10px !important;
        margin: 0 !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
    }
    
    h1 {
        font-size: 1.4em !important;
        margin-top: 10px !important;
        margin-bottom: 10px !important;
        padding: 0 5px !important;
    }
    
    /* Controls - FULL WIDTH in landscape */
    .controls {
        padding: 10px 15px !important;
        margin: 0 0 10px 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box !important;
        position: relative !important;
        border-radius: 10px !important;
    }
    
    /* Search bar - Full width */
    #searchInput {
        width: 100% !important;
        margin: 0 0 8px 0 !important;
        padding: 10px 15px !important;
        font-size: 0.9em !important;
        box-sizing: border-box !important;
    }
    
    /* Filter grid - FILL LANDSCAPE SCREEN */
    .filter-top-row {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 8px !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
    }
    
    /* Filter selects - Fill grid cells */
    .custom-select-trigger {
        width: 100% !important;
        padding: 8px 12px !important;
        font-size: 0.8em !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        border-radius: 25px !important;
    }
    
    /* Fix sub-brand filter if present */
    #subBrandWrapper[style*="inline-block"] {
        grid-column: span 1 !important;
    }
    
    /* Catalog container - Fill width */
    .catalog-container {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 10px !important;
        max-width: 100% !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        box-sizing: border-box !important;
    }
    
    /* Product cards - Adjust for landscape */
    .product-card {
        padding: 8px !important;
        border-radius: 8px !important;
    }
    
    .main-image img {
        height: 180px !important;
    }
    
    /* Cart button - Adjust position */
    .cart-summary-btn {
        position: absolute !important;
        right: 20px !important;
        top: 78px !important; /* Changed from 10px to 8px - MOVED UP */
        padding: 5px 14px !important; /* Reduced from 8px(vertical) 16px(horizontal) - NARROWER VERTICALLY */
        font-size: 0.8em !important;
    }
    
    /* Sort button row - Full width */
    .filter-bottom-row {
        width: 100% !important;
        margin: 8px 0 0 0 !important;
        padding-top: 8px !important;
        border-top: 1px solid rgba(212, 175, 55, 0.3) !important;
        display: flex !important;
        justify-content: space-between !important; /* Clear left, Sort right */
        align-items: center !important;
        box-sizing: border-box !important;
    }
    
    .clear-filters-container,
    .sort-button-container {
        width: auto !important;
    }
    
    .clear-filters-container .filter-btn,
    .sort-button-container .filter-btn {
        padding: 8px 16px !important;
        font-size: 0.8em !important;
        width: auto !important;
    }
    
    /* Hide mobile filters completely in landscape */
    .mobile-filter-triggers {
        display: none !important;
    }
    
    /* Size picker - Adjust for landscape */
    .size-picker {
        max-width: 70px !important;
    }
    
    .size-picker-trigger {
        font-size: 0.75em !important;
        padding: 4px 8px !important;
    }
    
    /* Product info - Adjust for landscape */
    .product-name {
        font-size: 0.65em !important;
        min-height: 2.2em !important;
        margin: 6px 0 4px 0 !important; /* Added 4px bottom padding */
        line-height: 1.3 !important;
        padding-bottom: 2px !important; /* Added bottom padding */
    }
    
    .product-price {
        font-size: 0.8em !important;
    }
    
    /* Thumbnails - Adjust for landscape */
    .thumbnails {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 3px !important;
        margin-top: 5px !important;
    }
    
    .thumbnail-img {
        height: 35px !important;
    }
    
    /* Ensure everything is properly box-sized */
    * {
        box-sizing: border-box !important;
    }
}

/* ============ CATALOG STYLES ============ */
input, select, button { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ddd; font-family: inherit; }

/* CATALOG CONTAINER - MAIN STYLES */
.catalog-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    /* REMOVE max-width: 1200px; */
    width: 100%; /* Use percentage instead to Match catalog width */
    max-width: 1600px; /* Higher limit for large screens */
    margin: 0 auto; /* Center it */
    box-sizing: border-box;
    padding: 0 5px;
}

/* PRODUCT CARD SIZING */
.product-card {
    background: white;
    padding: 12px; /* Increased padding for better spacing */
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    position: relative;
    width: 100%;
    box-sizing: border-box;
    transition: transform 0.2s ease;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Ensure images don't overflow */
.main-image img {
    width: 100%;
    height: 280px;
    object-fit: contain;
    cursor: pointer;
    max-width: 100%;
}

/* Size dropdown styling (old - kept for fallback) */
.size-select {
    font-size: 0.70em;
    font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #555;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    width: 80%;
    max-width: 120px;
}

/* Catalog quantity controls */
.catalog-qty-controls {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #f0f0f0;
    padding: 2x 4px;
    border-radius: 6px;
}

.catalog-qty-btn {
    background: #f0f0f0;
    border: 1px solid #ddd;
    padding: 2px 8px;
    cursor: pointer;
    border-radius: 3px;
    font-weight: bold;
    font-size: 0.8em;
    min-width: 28px;
}

.catalog-qty-btn:hover {
    background: #e5e5e5;
}

.catalog-qty-input {
    width: 40px;
    font-size: 0.8em;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 2px;
    background: white;
}

/* Ensure desktop always shows proper columns - INCLUDES LANDSCAPE */
@media (min-width: 769px), (orientation: landscape) {
    .catalog-container {
        grid-template-columns: repeat(4, 1fr) !important;
    }
}

.folder-tag { position: absolute; top: 5px; right: 5px; background: #333; color: white; padding: 2px 6px; font-size: 10px; border-radius: 3px; opacity: 0.7; z-index: 5; }

/* Prevent right-click, dragging, or saving images */
.main-image img, .thumbnail-img {
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
    pointer-events: auto;
}

.product-name { font-size: 0.65em; margin: 10px 0 -10px; font-weight: 600; min-height: 2.5em; color: #333; text-transform: capitalize; }
.product-price { font-size: 0.85em; }
.thumbnails { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-top: auto; }
.thumbnail-img { width: 100%; height: 40px; object-fit: cover; border: 1px solid #eee; border-radius: 4px; cursor: pointer; }

/* ============ IMAGE MODAL STYLES ============ */
#imageModal { display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); overflow:auto; text-align: center; }
#modalImg {
    margin: auto;
    display: inline-block;
    max-width: 90%;
    max-height: 90%;
    padding: 40px 0;
    transition: transform 0.2s ease;
    cursor: zoom-in;
}
#modalImg.zoomed {
    max-width: none;
    max-height: none;
    transform: scale(1.5);
}

.modal-arrows {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    color: white;
    border: none;
    font-size: 40px;
    padding: 15px;
    cursor: pointer;
    z-index: 1002;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
    opacity: 0.7;
    transition: opacity 0.3s ease;
    touch-action: manipulation;
}

.modal-arrows:hover {
    opacity: 1;
    background: transparent;
}

#prevBtn {
    left: 25%;
}

#nextBtn {
    right: 25%;
}

/* ============ CHECKOUT MODAL STYLES ============ */
#checkoutModal { 
    display: none;
    position: fixed;
    z-index: 1002;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow-y: auto;
}
.checkout-modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    width: 80%;
    max-width: 1000px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    position: relative;
}
.close-checkout { 
    position: absolute;
    right: 20px;
    top: 15px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1003;
}
.close-checkout:hover { color: #000; }

#checkoutModal {
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
}

/* ============ CHECKOUT LAYOUT STYLES ============ */
.header-bar { 
    background: white; 
    width: 100%; 
    padding: 20px 0; 
    text-align: center; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}
.logo { max-width: 100px; border: none; }

.page-wrapper { padding: 0 20px 40px; }

.checkout-master { 
    display: flex; 
    gap: 30px; 
    align-items: flex-start; 
}

.checkout-left { 
    flex: 1.1; 
    background: white; 
    padding: 35px; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
}

.checkout-right { 
    flex: 1; 
    background: white; 
    padding: 30px; 
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    position: sticky;
    top: 20px;
}

.cart-item { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
.cart-item img { width: 65px; height: 65px; object-fit: contain; border-radius: 6px; background: #fafafa; border: 1px solid #eee; }
.item-info { flex: 1; min-width: 0; overflow: hidden;}
.item-title { font-weight: 600; font-size: 0.85em; margin-bottom: 2px; width: 100%; max-width: 100%;}
.item-meta { font-size: 0.75em; color: #777; }

.qty-controls { display: flex; align-items: center; gap: 10px; }
.qty-btn { background: #f0f0f0; border: 1px solid #ddd; padding: 0px 8px; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 0.8em; }
.qty-btn:hover { background: #e5e5e5; }

.form-row { display: flex; gap: 15px; margin-bottom: 15px; }
.form-group { flex: 1; display: flex; flex-direction: column; }
.form-group label { font-size: 0.75em; font-weight: bold; margin-bottom: 6px; color: #555; }
.checkout-input, .checkout-select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9em; width: 100%; box-sizing: border-box; }
.checkout-input:focus { border-color: #000; outline: none; }

.checkbox-line { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-top: 10px; 
    font-size: 0.85em; 
    font-weight: normal; 
}
.checkbox-line input { width: auto; margin: 0; }

.divider { border-top: 1px solid #eee; margin: 30px 0 15px; padding-top: 15px; font-weight: bold; font-size: 1em; text-transform: uppercase; letter-spacing: 0.5px; }

.shipping-method-row {
    display: flex; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
}
.shipping-method-row:hover { border-color: #000; }
.shipping-method-row.selected { border-color: #0058ff; background: #f0f4ff; }
.shipping-method-row input { width: auto; margin-right: 15px; pointer-events: none; }
.shipping-info { flex: 1; }
.shipping-name { font-size: 0.9em; font-weight: 600; }
.shipping-desc { font-size: 0.75em; color: #777; }
.shipping-cost { font-weight: 600; font-size: 0.9em; }

.payment-container { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-top: 15px; }
.payment-row { 
    display: flex; align-items: center; padding: 15px; background: #fff; cursor: pointer; 
    border-bottom: 1px solid #eee; transition: background 0.2s;
}
.payment-row:last-child { border-bottom: none; }
.payment-row:hover { background: #f9f9f9; }
.payment-row input[type="radio"] { width: auto; margin-right: 15px; }
.payment-label { flex: 1; font-weight: 600; font-size: 0.9em; }
.payment-icons { display: flex; gap: 5px; }
.payment-icons img { height: 18px; }

.billing-section { 
    background: #fcfcfc; padding: 0 25px; 
    max-height: 0; overflow: hidden; 
    transition: max-height 0.3s ease-out, padding 0.3s ease;
}
.billing-section.active { 
    max-height: 800px; padding: 15x 25px; border-top: 1px solid #efefef; 
}

.bubble-container { display: flex; gap: 10px; margin-bottom: 10px; }
.bubble { 
    flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; 
    border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; 
    background: white; transition: all 0.2s;
}
.bubble.selected { background: #000; color: #fff; border-color: #000; }

.crypto-option { 
    border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 10px; 
    cursor: pointer; background: white; font-size: 0.9em; font-weight: 600;
    display: flex; justify-content: flex-start; align-items: center;
}
.crypto-option:hover { border-color: #000; }
.crypto-address-inline { 
    font-family: monospace; font-size: 0.8em; color: #0058ff; 
    background: #f0f4ff; padding: 4px 8px; border-radius: 4px; 
    display: none; word-break: break-all; margin-left: 15px;
    font-weight: normal;
}

.info-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    background: #ddd;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    margin-left: 5px;
    color: #555;
    vertical-align: middle;
}
.info-trigger:hover { background: #ccc; }

.summary-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 0.95em; }
.total-box { border-top: 2px solid #000; margin-top: 20px; padding-top: 15px; font-weight: bold; font-size: 1.25em; display: flex; justify-content: space-between; }

.complete-btn { 
    width: 100%; 
    background: #0058ff; 
    color: white; 
    padding: 18px; 
    border: none; 
    border-radius: 8px; 
    font-weight: bold; 
    font-size: 1em; 
    cursor: pointer; 
    margin-top: 25px; 
    transition: background 0.2s; 
}
.complete-btn:hover { background: #0047cc; }

.disabled-method { opacity: 0.6; cursor: not-allowed; background: #f9f9f9 !important; }

/* LOAD MORE BUTTON */
#loadMoreBtn {
    padding: 14px 30px;
    border: 2px solid #D4AF37;
    border-radius: 30px;
    background: linear-gradient(135deg, #000 0%, #2d2d2d 100%);
    color: #FFD700;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: none;
    margin: 30px auto;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#loadMoreBtn:hover {
    background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
    color: #000;
    border-color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(212, 175, 55, 0.4);
}

/* Mobile responsive LOAD MORE BUTTON */
@media (max-width: 768px) {
    #loadMoreBtn {
        padding: 12px 25px;
        font-size: 0.9em;
        margin: 20px auto;
        width: 80%;
        max-width: 250px;
    }
}

@media (max-width: 950px) {
    .checkout-master { flex-direction: column; }
    .checkout-right { order: -1; margin-bottom: 20px; position: static; width: 100%; box-sizing: border-box; }
    .checkout-left { width: 100%; box-sizing: border-box; }
    .crypto-option { flex-direction: column; align-items: flex-start; gap: 5px; }
    .crypto-address-inline { margin-left: 0; width: 100%; box-sizing: border-box; }
}

</style>
</head>
<body>

<!-- ============ MAIN CATALOG SECTION ============ -->
<h1> Master Product Catalog</h1>
<div class="controls">
    <!-- For Her / For Him Buttons -->
    <div class="gender-tabs-container">
        <button class="gender-tab active" id="forHerTab" onclick="setGenderFilter('forHer')">
            For Her
            <span class="gender-underline" style="transform: scaleX(1);"></span>
        </button>
        <button class="gender-tab" id="forHimTab" onclick="setGenderFilter('forHim')">
            For Him
            <span class="gender-underline"></span>
        </button>
    </div>
    
    <!-- Search Bar -->
    <div class="filter-group">
        <input type="text" id="searchInput" oninput="debouncedApplyFilters()" placeholder=" Search products...">
    </div>
    
<!-- Top Row: All Filters (CUSTOM DROPDOWN STYLING) -->
<div class="filter-top-row">
    <!-- Custom Brand Dropdown -->
    <div class="custom-select-wrapper">
        <div class="custom-select-trigger" onclick="toggleCustomDropdown('brand')">
            <span class="select-placeholder">All Brands</span>
            <span class="select-arrow"></span>
        </div>
        <div class="custom-select-dropdown" id="brand-dropdown">
            <div class="custom-select-header">
                <span>Select Brand</span>
                <button class="custom-select-close" onclick="closeCustomDropdown('brand')"></button>
            </div>
            <div class="custom-select-options" id="brand-options">
                <div class="custom-select-option selected" data-value="" onclick="selectCustomOption('brand', '', 'All Brands')">
                    All Brands
                </div>
            </div>
        </div>
        <input type="hidden" id="brandFilter" value="">
    </div>
    
    <!-- Custom Sub-Brand Dropdown -->
    <div class="custom-select-wrapper" id="subBrandWrapper" style="display: none;">
        <div class="custom-select-trigger" onclick="toggleCustomDropdown('subBrand')">
            <span class="select-placeholder">Sub-Brand</span>
            <span class="select-arrow"></span>
        </div>
        <div class="custom-select-dropdown" id="subBrand-dropdown">
            <div class="custom-select-header">
                <span>Select Sub-Brand</span>
                <button class="custom-select-close" onclick="closeCustomDropdown('subBrand')"></button>
            </div>
            <div class="custom-select-options" id="subBrand-options">
                <div class="custom-select-option selected" data-value="" onclick="selectCustomOption('subBrand', '', 'Sub-Brand')">
                    Sub-Brand
                </div>
            </div>
        </div>
        <input type="hidden" id="subBrandFilter" value="">
    </div>
    
    <!-- Custom Category Dropdown -->
    <div class="custom-select-wrapper">
        <div class="custom-select-trigger" onclick="toggleCustomDropdown('category')">
            <span class="select-placeholder">All Categories</span>
            <span class="select-arrow"></span>
        </div>
        <div class="custom-select-dropdown" id="category-dropdown">
            <div class="custom-select-header">
                <span>Select Category</span>
                <button class="custom-select-close" onclick="closeCustomDropdown('category')"></button>
            </div>
            <div class="custom-select-options" id="category-options">
                <div class="custom-select-option selected" data-value="" onclick="selectCustomOption('category', '', 'All Categories')">
                    All Categories
                </div>
            </div>
        </div>
        <input type="hidden" id="catFilter" value="">
    </div>
    
    <!-- Custom Type Dropdown -->
    <div class="custom-select-wrapper">
        <div class="custom-select-trigger" onclick="toggleCustomDropdown('type')">
            <span class="select-placeholder">All Product Types</span>
            <span class="select-arrow"></span>
        </div>
        <div class="custom-select-dropdown" id="type-dropdown">
            <div class="custom-select-header">
                <span>Select Product Type</span>
                <button class="custom-select-close" onclick="closeCustomDropdown('type')"></button>
            </div>
            <div class="custom-select-options" id="type-options">
                <div class="custom-select-option selected" data-value="" onclick="selectCustomOption('type', '', 'All Product Types')">
                    All Product Types
                </div>
            </div>
        </div>
        <input type="hidden" id="typeFilter" value="">
    </div>
</div>

<!-- Custom dropdown overlay (mobile) -->
<div class="custom-select-overlay" onclick="closeAllCustomDropdowns()"></div>
    
    <!-- Bottom Row: Clear Filters left, Sort button right -->
    <div class="filter-bottom-row">
        <!-- Clear Filters Button (LEFT) -->
        <div class="clear-filters-container">
            <button class="filter-btn" onclick="clearAllFilters()">
                <span class="btn-icon"></span> Clear Filters
            </button>
        </div>
        
        <!-- Sort Button (RIGHT) -->
        <div class="sort-button-container">
            <button class="filter-btn" onclick="sortByPrice()">
                <span class="btn-icon"></span> Sort by Price
            </button>
        </div>
    </div>
    
    <!-- Cart Button -->
    <button class="cart-summary-btn" onclick="openCheckoutModal()">
        <span class="cart-icon"></span>
        <span class="cart-text">Cart</span>
        <span class="cart-count" id="cartCount">0</span>
    </button>
</div>

<!-- Size picker overlay (mobile) -->
<div class="size-overlay" onclick="closeAllSizePickers()"></div>

<!-- Image Zoom Modal -->
<div id="imageModal" onclick="handleBackgroundClick(event)">
    <img id="modalImg" onclick="toggleZoom(event)">
    <button class="modal-arrows" id="prevBtn" onclick="changeModalImage(-1)" style="display:none;">&lt;</button>
    <button class="modal-arrows" id="nextBtn" onclick="changeModalImage(1)" style="display:none;">&gt;</button>
</div>

<!-- Product Catalog Container -->
<div class="catalog-container" id="container"></div>

<!-- Load More Button -->
<div style="text-align:center;">
    <button id="loadMoreBtn" onclick="loadMore()">Load More</button>
</div>

<!-- ============ CHECKOUT MODAL ============ -->
<div id="checkoutModal">
    <div class="checkout-modal-content">
        <span class="close-checkout" onclick="closeCheckoutModal()">&times;</span>
        
        <div class="header-bar">
            <img src="https://veloxxa.com/cdn/shop/files/logo-removebg-preview.png?v=1763035693&width=120" class="logo" alt="Veloxxa Logo">
        </div>
        
        <div class="page-wrapper">
            <div class="checkout-master">
                <!-- LEFT COLUMN: Customer Information & Payment -->
                <div class="checkout-left">
                    <h2 style="margin-top: 0; font-size: 1.4em;">Customer Information</h2>
                    <div class="form-row">
                        <div class="form-group"><label>First Name *</label><input type="text" id="fname" class="checkout-input" required placeholder="First name"></div>
                        <div class="form-group"><label>Last Name *</label><input type="text" id="lname" class="checkout-input" required placeholder="Last name"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="email" class="checkout-input" required placeholder="jane@example.com">
                            <div class="checkbox-line">
                                <input type="checkbox" id="news" checked>
                                <label for="news">Email me news and offers</label>
                            </div>
                        </div>
                        <div class="form-group"><label>Phone Number *</label><input type="tel" id="phone" class="checkout-input" required placeholder="+XX XXX XXX XXXX"></div>
                    </div>

                    <div class="divider">Shipping Address</div>
                    <div class="form-group"><label>Street Address *</label><input type="text" id="addr" class="checkout-input" required placeholder="House number and street name"></div>
                    
                    <div class="form-row" style="margin-top:15px;">
                        <div class="form-group">
                            <label>Country *</label>
                            <select id="country" class="checkout-select" onchange="toggleCOD()"></select>
                        </div>
                        <div class="form-group"><label>City *</label><input type="text" id="city" class="checkout-input" required></div>
                        <div class="form-group"><label>Zipcode *</label><input type="text" id="zip" class="checkout-input" required></div>
                    </div>

                    <div class="divider">Shipping Method</div>
                    <div id="shipping_methods_container"></div>

                    <div class="divider">Payment</div>
                    <div class="payment-container">
                        <!-- Credit/Debit Card Section -->
                        <div class="payment-row" onclick="setPaymentMethod('card')">
                            <input type="radio" name="pay_choice" id="radio_card">
                            <div class="payment-label">Credit/Debit Card</div>
                            <div class="payment-icons">
                                <img src="https://img.icons8.com/color/48/000000/visa.png">
                                <img src="https://img.icons8.com/color/48/000000/mastercard.png">
                                <img src="https://img.icons8.com/color/48/000000/amex.png">
                                <img src="https://img.icons8.com/color/48/000000/discover.png">
                                <img src="https://img.icons8.com/color/48/000000/jcb.png">
                            </div>
                        </div>

                        <!-- Card Details Input Section -->
                        <div id="card_section" class="billing-section">
                            <!--
                            <div class="form-group"><label>Name on Card</label><input type="text" id="cardName" class="checkout-input" placeholder="Full name on card"></div>
                            <div class="form-group" style="margin-top: 12px;"><label>Card Number</label><input type="text" class="checkout-input" placeholder="Card number"></div>
                            <div class="form-row" style="margin-top: 12px;">
                                <div class="form-group"><label>Expiration Date</label><input type="text" class="checkout-input" placeholder="MM/YY"></div>
                                <div class="form-group"><label>CVC</label><input type="text" class="checkout-input" placeholder="XXX"></div>
                            </div>
                            -->
                        </div>

                        <!-- Cash on Delivery (COD) Section -->
                        <div class="payment-row" id="cod_row" style="display:none;" onclick="setPaymentMethod('cod')">
                            <input type="radio" name="pay_choice" id="radio_cod">
                            <div class="payment-label">Cash on Delivery (COD)</div>
                        </div>

                        <!-- COD Deposit Method Section -->
                        <div id="cod_card_section" class="billing-section">
                            <p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">A 33% Service Fee is required for COD orders. Please choose a deposit method below.</p>
                            
                            <div class="bubble-container">
                                <div class="bubble" id="bubble_card" onclick="setCODSubMethod('card')">Pay via Card</div>
                                <div class="bubble" id="bubble_crypto" onclick="setCODSubMethod('crypto')">Pay via Crypto</div>
                            </div>

                            <!-- COD Card Payment Subsection -->
                            <div id="cod_sub_card" style="display:none;">
                                <!--
                                <div class="form-group"><label>Name on Card</label><input type="text" id="cardNameCOD" class="checkout-input" placeholder="Full name on card"></div>
                                <div class="form-group" style="margin-top: 12px;"><label>Card Number</label><input type="text" class="checkout-input" placeholder="Card number"></div>
                                <div class="form-row" style="margin-top: 12px;">
                                    <div class="form-group"><label>Expiration Date</label><input type="text" class="checkout-input" placeholder="MM/YY"></div>
                                    <div class="form-group"><label>CVC</label><input type="text" class="checkout-input" placeholder="XXX"></div>
                                </div>
                                -->
                            </div>

                            <!-- COD Crypto Payment Subsection -->
                            <div id="cod_sub_crypto" style="display:none;">
                                 <p style="font-size: 0.8em; color: #ff4d4d; font-weight: 600; margin-bottom: 10px;">Service Fee payment must be sent within 24 hours.</p>
                                 <div class="crypto-option" onclick="showCryptoAddr('usdt_cod')"><img src="https://img.icons8.com/color/24/000000/tether--v1.png" style="width:20px;height:20px;">USDT <span id="addr_usdt_cod" class="crypto-address-inline">Address Currently Unavailable</span></div>
                                 <div class="crypto-option" onclick="showCryptoAddr('usdc_cod')"><img src="https://img.icons8.com/?size=100&id=1jPxlShNofZt&format=png&color=000000" style="width:20px;height:20px;">USDC <span id="addr_usdc_cod" class="crypto-address-inline">Address Currently Unavailable</span></div>
                                 <div class="crypto-option" onclick="showCryptoAddr('eth_cod')"><img src="https://img.icons8.com/ios-filled/50/000000/ethereum.png" style="width:20px;height:20px;">Etherium <span id="addr_eth_cod" class="crypto-address-inline">Address Currently Unavailable</span></div>
                                 <div class="crypto-option" onclick="showCryptoAddr('btc_cod')"><img src="https://img.icons8.com/color/48/000000/bitcoin--v1.png" style="width:20px;height:20px;">Bitcoin <span id="addr_btc_cod" class="crypto-address-inline">Address Currently Unavailable</span></div>
                            </div>
                        </div>
                        <!-- Crypto Payment Section -->
                        <div class="payment-row" onclick="setPaymentMethod('crypto')">
                            <input type="radio" name="pay_choice" id="radio_crypto">
                            <div class="payment-label">Crypto</div>
                            <div class="payment-icons">
                                <img src="https://img.icons8.com/color/48/000000/tether.png" alt="USDT">
                                <img src="https://img.icons8.com/?size=100&id=1jPxlShNofZt&format=png&color=000000" alt="USDC">
                                <img src="https://img.icons8.com/ios-filled/50/000000/ethereum.png" alt="Ethereum">
                                <img src="https://img.icons8.com/color/48/000000/bitcoin--v1.png">
                                <img src="https://img.icons8.com/color/48/000000/cryptocurrency.png" alt="Crypto">
                            </div>
                        </div>
                        <!-- Crypto Details Section -->
                        <div id="crypto_section" class="billing-section">
                            <p style="font-size: 0.85em; color: #ff4d4d; margin-bottom: 15px; font-weight: 600;">Crypto payment must be sent within 24 hours.</p>
                            <div class="crypto-option" onclick="showCryptoAddr('usdt')"><img src="https://img.icons8.com/color/24/000000/tether--v1.png" style="width:20px;height:20px;">USDT <span id="addr_usdt" class="crypto-address-inline">Address Currently Unavailable</span></div>
                            <div class="crypto-option" onclick="showCryptoAddr('usdc')"><img src="https://img.icons8.com/?size=100&id=1jPxlShNofZt&format=png&color=000000" style="width:20px;height:20px;">USDC <span id="addr_usdc" class="crypto-address-inline">Address Currently Unavailable</span></div>
                            <div class="crypto-option" onclick="showCryptoAddr('eth')"><img src="https://img.icons8.com/ios-filled/50/000000/ethereum.png" style="width:20px;height:20px;">Etherium <span id="addr_eth" class="crypto-address-inline">Address Currently Unavailable</span></div>
                            <div class="crypto-option" onclick="showCryptoAddr('btc')"><img src="https://img.icons8.com/color/48/000000/bitcoin--v1.png" style="width:20px;height:20px;">Bitcoin <span id="addr_btc" class="crypto-address-inline">Address Currently Unavailable</span></div>
                        </div>
                    </div>

                    <button class="complete-btn" onclick="submitOrderToFormspree()" style="margin: 25px 15px 15px; width: calc(100% - 30px);">Complete Request</button>
                </div>

                <!-- RIGHT COLUMN: Order Summary -->
                <div class="checkout-right">
                    <h3 style="margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 10px;">Order Summary</h3>
                    <div id="cartList"></div>
                    <div style="margin-top: 25px;">
                        <div class="summary-row" style="font-weight: bold; font-size: 1.0em; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px;"><span>Subtotal</span><span id="subtotalBox">$0.00</span></div>
                        <div class="summary-row">
                            <span>
                                Service Fee (33%) 
                                <span class="info-trigger" onclick="showServiceInfo()">?</span>
                            </span>
                            <span id="serviceFeeBox" style="color: #666;">Included</span>
                        </div>
                        <div class="summary-row"><span id="shippingLabel">Shipping</span><span id="shippingBox">$0.00</span></div>
                        <div class="total-box"><span>Total</span><span id="totalBox">$0.00</span></div>
                        
                        <!-- COD Payment Breakdown (shown only when COD is selected) -->
                        <div id="codBreakdown" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                            <div class="summary-row" style="color: #c9302c; font-weight: bold;">
                                <span>Due Today (33% Service Fee)</span>
                                <span id="dueTodayBox">$0.00</span>
                            </div>
                            <div class="summary-row" style="color: #28a745; font-weight: bold;">
                                <span>Due on Delivery</span>
                                <span id="dueOnDeliveryBox">$0.00</span>
                            </div>
                            <div style="font-size: 0.75em; color: #666; margin-top: 10px; font-style: italic;">
                                Service fee must be paid within 24 hours to confirm your COD order.
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; margin-top: 25px; color: #888; text-decoration: none; font-size: 0.85em;">Continue shopping to add more items</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// GLOBAL VARIABLES & CONFIGURATION
// ============================================

// Add this line with your Python CATALOG_SETTINGS values
const CATALOG_SETTINGS = {
    "SALE_PRICE_COLUMN": "Veloxxa Price",
    "ORIGINAL_PRICE_COLUMN": "Veloxxa Original Price Catalog",
    "MAIN_PRICE_COLOR": "#c9302c",
    "DISCOUNTED_PRICE_COLOR": "gray",
    "THUMBNAIL_HOVER_COLOR": "#007bff",
    "CARD_BACKGROUND_COLOR": "transparent",
    "CARD_BORDER_COLOR": "none",
    "GRID_COLUMNS": 4,
    "THUMBNAILS_PER_ROW": 6,
    "MODAL_ZOOM_LEVEL": 1.5,
    "PRODUCT_NAME_FONT_SIZE": "0.65em",
    "PRODUCT_PRICE_FONT_SIZE": "0.85em",
    "PRODUCT_NAME_FONT_FAMILY": "'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif",
    "PRODUCT_PRICE_FONT_FAMILY": "'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif"
};

const CART_STORAGE_KEY = "catalog_cart";
const TARGET_FOLDERS = ["Ashford"];
const SUB_BRAND_ENABLED_GLOBALLY = true;
const ENABLE_SCROLL_LOAD = true;
const ENABLE_BUTTON_LOAD = true;
const INITIAL_PRODUCT_LOAD = 8;
const LOAD_MORE_BATCH = 8;
const FEE_PERCENT = 0;
const MOBILE_COLUMNS = 2; // Set to 1 or 2 only

// BRAND MAPPING FROM PYTHON
const BRAND_NAME_MAP = {
    "MK": "Michael Kors",
    "Guess Factory": "Guess Outlet",
    "Guess": "Guess",
    "Fossil": "Fossil",
    "Ashford": "US Outlet",
    "Jomashop": "Jomashop",
};

// GENDER FILTER SETTINGS
let activeGenderFilter = "forHer"; // Default to "For Her" as requested

let allCards = [];
let cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || [];
let asc = true;
let selectedShippingId = null;
let codSubMethod = null;
let shippingMethodName = "Shipping";
let filterTimeout;
let cachedDropdowns = {};
let activeSizePicker = null;
let initialLoadComplete = false;

// ============================================
// NEW: FOR HER/FOR HIM FUNCTIONALITY
// ============================================

/**
 * Sets the gender filter (For Her or For Him)
 * @param gender - "forHer" or "forHim"
 */
function setGenderFilter(gender) {
    activeGenderFilter = gender;
    
    // Update tab UI
    const forHerTab = document.getElementById('forHerTab');
    const forHimTab = document.getElementById('forHimTab');
    
    if (gender === 'forHer') {
        forHerTab.classList.add('active');
        forHimTab.classList.remove('active');
        forHerTab.querySelector('.gender-underline').style.transform = 'scaleX(1)';
        forHimTab.querySelector('.gender-underline').style.transform = 'scaleX(0)';
    } else {
        forHimTab.classList.add('active');
        forHerTab.classList.remove('active');
        forHimTab.querySelector('.gender-underline').style.transform = 'scaleX(1)';
        forHerTab.querySelector('.gender-underline').style.transform = 'scaleX(0)';
    }
    
    // Apply filters
    applyFilters();
}

/**
 * Checks if a product matches the active gender filter
 * @param gender - The product's gender value
 * @returns boolean - True if product should be shown
 */
function matchesGenderFilter(gender) {
    if (!gender || typeof gender !== 'string') {
        return false;
    }
    
    const genderLower = gender.toLowerCase().trim();
    
    // Check for unisex/both first (these show in both filters)
    if (genderLower.includes('unisex') || genderLower.includes('both')) {
        return true;
    }
    
    // "For Her" shows Women + Female
    if (activeGenderFilter === 'forHer') {
        const matches = genderLower.includes('women') || genderLower.includes('female');
        return matches;
    }
    // "For Him" shows Men + Male (and explicitly NOT Women/Female)
    else if (activeGenderFilter === 'forHim') {
        const matches = (genderLower.includes('men') || genderLower.includes('male')) 
                        && !genderLower.includes('women') 
                        && !genderLower.includes('female');
        return matches;
    }
    return false;
}

// ============================================
// NEW: CLEAR FILTERS FUNCTION
// ============================================

/**
 * Clears all filters except For Her/For Him setting
 */
function clearAllFilters() {
    console.log(' Clearing all filters...');
    
    // Clear search input
    document.getElementById('searchInput').value = '';
    
    // Clear brand filter
    selectCustomOption('brand', '', 'All Brands');
    
    // Clear sub-brand filter if visible
    const subBrandWrapper = document.getElementById('subBrandWrapper');
    if (subBrandWrapper.style.display !== 'none') {
        selectCustomOption('subBrand', '', 'Sub-Brand');
    }
    
    // Clear category filter
    selectCustomOption('category', '', 'All Categories');
    
    // Clear type filter
    selectCustomOption('type', '', 'All Product Types');
    
    // Note: DO NOT clear gender filter (For Her/For Him setting)
    
    // Load initial products
    loadInitialProducts();
    
    // Apply filters
    applyFilters();
    
    console.log(' All filters cleared (except For Her/For Him)');
}

// ============================================
// DEBOUNCE & THROTTLE FUNCTIONS FOR PERFORMANCE
// ============================================

function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function throttle(func, limit = 100) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// Create debounced version of applyFilters
const debouncedApplyFilters = debounce(applyFilters, 300);

// ============================================
// CUSTOM FILTER SELECTOR FUNCTIONS (UPDATED TO MATCH SIZE PICKER)
// ============================================

let activeCustomDropdown = null;

/**
 * Toggles a custom dropdown
 * @param type - The dropdown type (brand, category, etc.)
 */
function toggleCustomDropdown(type) {
    const dropdown = document.getElementById(`${type}-dropdown`);
    const trigger = dropdown.closest('.custom-select-wrapper').querySelector('.custom-select-trigger');
    const overlay = document.querySelector('.custom-select-overlay');
    
    // If this dropdown is already open, close it
    if (activeCustomDropdown === type) {
        closeCustomDropdown(type);
        return;
    }
    
    // Close any other open dropdown first
    closeAllCustomDropdowns();
    
    if (dropdown) {
        activeCustomDropdown = type;
        dropdown.classList.add('active');
        trigger.classList.add('active');
        
        // Add active-wrapper class for z-index fix
        dropdown.closest('.custom-select-wrapper').classList.add('active-wrapper');
        
        // Mobile portrait: show overlay and prevent body scroll
        if (window.innerWidth <= 768 && window.matchMedia("(orientation: portrait)").matches) {
            if (overlay) {
                overlay.classList.add('active');
            }
            document.body.style.overflow = 'hidden';
        }
        // Desktop & landscape: no overlay, allow scrolling
        else {
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
        }
    }
}

/**
 * Closes a specific custom dropdown
 * @param type - The dropdown type to close
 */
function closeCustomDropdown(type) {
    const dropdown = document.getElementById(`${type}-dropdown`);
    const trigger = document.querySelector(`#${type}-dropdown`).closest('.custom-select-wrapper').querySelector('.custom-select-trigger');
    const overlay = document.querySelector('.custom-select-overlay');
    
    if (dropdown) {
        dropdown.classList.remove('active');
        trigger.classList.remove('active');
        activeCustomDropdown = null;
    }
    
    // Always hide overlay and restore scrolling
    if (overlay) {
        overlay.classList.remove('active');
    }
    document.body.style.overflow = '';
}

/**
 * Closes all custom dropdowns
 */
function closeAllCustomDropdowns() {
    document.querySelectorAll('.custom-select-dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
    });
    
    document.querySelectorAll('.custom-select-trigger.active').forEach(trigger => {
        trigger.classList.remove('active');
    });
    
    const overlay = document.querySelector('.custom-select-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    
    activeCustomDropdown = null;
    document.body.style.overflow = '';
}

/**
 * Selects an option in a custom dropdown
 * @param type - The dropdown type
 * @param value - The selected value
 * @param label - The display label
 */
function selectCustomOption(type, value, label) {
    console.log(` selectCustomOption called: type=${type}, value=${value}, label=${label}`);
    
    // Map dropdown types to their correct input IDs
    const inputIdMap = {
        'brand': 'brandFilter',
        'subBrand': 'subBrandFilter',
        'category': 'catFilter',
        'type': 'typeFilter'
    };
    
    const inputId = inputIdMap[type];
    if (!inputId) {
        console.error(` No input ID mapped for type: ${type}`);
        return;
    }
    
    // Update the hidden input
    const filterInput = document.getElementById(inputId);
    if (filterInput) {
        console.log(`Updating ${inputId} from "${filterInput.value}" to "${value}"`);
        filterInput.value = value;
    } else {
        console.error(` ${inputId} input not found! Looking for #${inputId}`);
        const allFilters = Array.from(document.querySelectorAll('input[id$="Filter"]')).map(i => i.id);
        console.log("Available filter inputs:", allFilters);
    }
    
    // Update the trigger display
    const dropdown = document.getElementById(`${type}-dropdown`);
    if (!dropdown) {
        console.error(` ${type}-dropdown not found!`);
        return;
    }
    
    const trigger = dropdown.closest('.custom-select-wrapper').querySelector('.custom-select-trigger .select-placeholder');
    if (trigger) {
        const displayLabel = label || (type === 'brand' ? 'All Brands' : 
                                     type === 'subBrand' ? 'Sub-Brand' : 
                                     type === 'category' ? 'All Categories' :
                                     'All Product Types');
        trigger.textContent = displayLabel;
        trigger.style.color = value ? '#FFD700' : '#FFD700';
        trigger.style.fontWeight = value ? '600' : '500';
        console.log(` Updated trigger text to: "${displayLabel}"`);
    } else {
        console.error(` Trigger not found for ${type} dropdown`);
    }
    
    // Remove selected class from all options and add to selected one
    const options = document.querySelectorAll(`#${type}-options .custom-select-option`);
    options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.value === value) {
            option.classList.add('selected');
        }
    });
    
    // Close the dropdown
    closeCustomDropdown(type);
    
    console.log(` Calling ${type} filter change handler...`);
    
    // Trigger the appropriate filter change function
    switch(type) {
        case 'brand':
            handleBrandChange();
            break;
        case 'subBrand':
            handleSubBrandChange();
            break;
        case 'category':
            handleCategoryChange();
            break;
        case 'type':
            handleTypeChange();
            break;
    }
    
    console.log(` ${type} selection complete`);
}

/**
 * Populates a custom dropdown with options
 * @param type - The dropdown type
 * @param options - Array of {value: '', label: ''} objects
 * @param currentValue - Currently selected value
 */
function populateCustomSelect(type, options, currentValue) {
    const optionsContainer = document.getElementById(`${type}-options`);
    if (!optionsContainer) return;
    
    let html = '';
    
    // Add "All" option first
    const allOption = {
        value: '',
        label: type === 'brand' ? 'All Brands' : 
               type === 'subBrand' ? 'Sub-Brand' : 
               type === 'category' ? 'All Categories' :
               'All Product Types'
    };
    
    html += `<div class="custom-select-option ${currentValue === '' ? 'selected' : ''}" 
                    data-value="" 
                    onclick="selectCustomOption('${type}', '', '${allOption.label}')">
                ${allOption.label}
            </div>`;
    
    // Add other options
    options.forEach(option => {
        if (!option.value || option.value.trim() === '') return;
        
        const isSelected = option.value === currentValue;
        html += `<div class="custom-select-option ${isSelected ? 'selected' : ''}" 
                        data-value="${option.value}" 
                        onclick="selectCustomOption('${type}', '${option.value}', '${option.label}')">
                    ${option.label}
                </div>`;
    });
    
    optionsContainer.innerHTML = html;
    
    // Update the trigger placeholder
    const trigger = document.querySelector(`#${type}-dropdown`).closest('.custom-select-wrapper').querySelector('.custom-select-trigger .select-placeholder');
    if (trigger) {
        const selectedOption = currentValue ? 
            options.find(opt => opt.value === currentValue)?.label || allOption.label : 
            allOption.label;
        trigger.textContent = selectedOption;
        trigger.style.color = currentValue ? '#FFD700' : '#FFD700';
        trigger.style.fontWeight = currentValue ? '600' : '500';
    }
}

/**
 * Gets the current value of a custom dropdown
 * @param type - The dropdown type
 * @returns The current value or empty string
 */
function getCustomSelectValue(type) {
    // Map dropdown types to their correct input IDs
    const inputIdMap = {
        'brand': 'brandFilter',
        'subBrand': 'subBrandFilter',
        'category': 'catFilter',
        'type': 'typeFilter'
    };
    
    const inputId = inputIdMap[type];
    if (!inputId) {
        console.error(`No input ID mapped for type: ${type}`);
        return '';
    }
    
    const input = document.getElementById(inputId);
    return input ? input.value : '';
}

// Close dropdowns when clicking outside (desktop) or on overlay (mobile)
document.addEventListener('click', function(e) {
    // Don't close if clicking on a dropdown trigger or option
    if (e.target.closest('.custom-select-trigger') || 
        e.target.closest('.custom-select-option') ||
        e.target.closest('.custom-select-close')) {
        return;
    }
    
    // Close if clicking outside the dropdown (works for all devices)
    if (activeCustomDropdown && !e.target.closest('.custom-select-dropdown')) {
        closeAllCustomDropdowns();
    }
    
    // Don't close if clicking on a size picker trigger or option
    if (e.target.closest('.size-picker-trigger') || 
        e.target.closest('.size-option') ||
        e.target.closest('.size-picker-close')) {
        return;
    }
    
    // Close if clicking outside the size picker (works for all devices)
    if (activeSizePicker && !e.target.closest('.size-picker-dropdown')) {
        closeAllSizePickers();
    }
});

// Close dropdowns with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (activeCustomDropdown) {
            closeAllCustomDropdowns();
        }
        if (activeSizePicker) {
            closeAllSizePickers();
        }
    }
});

// ============================================
// SIZE PICKER FUNCTIONS (UPDATED)
// ============================================

/**
 * Opens the size picker for a specific product
 * @param productId - The ID of the product
 */
function openSizePicker(productId) {
    // Close any open size picker first
    closeAllSizePickers();
    
    const sizePicker = document.getElementById(`size-picker-${productId}`);
    const overlay = document.querySelector('.size-overlay');
    
    if (sizePicker) {
        activeSizePicker = productId;
        sizePicker.classList.add('active');
        
        // Mobile portrait: show overlay and prevent body scroll
        if (window.innerWidth <= 768 && window.matchMedia("(orientation: portrait)").matches) {
            if (overlay) {
                overlay.classList.add('active');
            }
            document.body.style.overflow = 'hidden';
        }
        // Desktop & landscape: no overlay, allow scrolling
        else {
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
        }
    }
}

/**
 * Closes the size picker for a specific product
 * @param productId - The ID of the product
 */
function closeSizePicker(productId) {
    const sizePicker = document.getElementById(`size-picker-${productId}`);
    const overlay = document.querySelector('.size-overlay');
    
    if (sizePicker) {
        sizePicker.classList.remove('active');
        activeSizePicker = null;
    }
    
    // Always hide overlay and restore scrolling
    if (overlay) {
        overlay.classList.remove('active');
    }
    document.body.style.overflow = '';
}

/**
 * Closes all open size pickers
 */
function closeAllSizePickers() {
    document.querySelectorAll('.size-picker-dropdown.active').forEach(picker => {
        picker.classList.remove('active');
    });
    
    const overlay = document.querySelector('.size-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    
    activeSizePicker = null;
    document.body.style.overflow = '';
}

/**
 * Selects a size for a product
 * @param productId - The ID of the product
 * @param size - The selected size
 */
function selectSize(productId, size) {
    // Update the hidden input
    const sizeInput = document.getElementById(`selected-size-${productId}`);
    if (sizeInput) {
        sizeInput.value = size;
    }
    
    // Update the trigger display
    const trigger = document.querySelector(`#size-picker-${productId}`).closest('.size-picker').querySelector('.size-picker-trigger .size-placeholder');
    if (trigger) {
        trigger.textContent = size;
        trigger.style.color = '#000';
        trigger.style.fontWeight = '600';
    }
    
    // Remove selected class from all options and add to selected one
    const options = document.querySelectorAll(`#size-picker-${productId} .size-option`);
    options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.size === size) {
            option.classList.add('selected');
        }
    });
    
    // Close the picker (works for both mobile and desktop)
    closeSizePicker(productId);
}

/**
 * Gets the selected size for a product
 * @param productId - The ID of the product
 * @returns The selected size or empty string if none selected
 */
function getSelectedSize(productId) {
    const sizeInput = document.getElementById(`selected-size-${productId}`);
    return sizeInput ? sizeInput.value : '';
}

// Close size picker when clicking outside (desktop) or on overlay (mobile)
document.addEventListener('click', function(e) {
    // Don't close if clicking on a size picker trigger or option
    if (e.target.closest('.size-picker-trigger') || 
        e.target.closest('.size-option') ||
        e.target.closest('.size-picker-close')) {
        return;
    }
    
    // Close if clicking outside on desktop
    if (window.innerWidth > 768 || 
        (window.innerWidth <= 768 && window.matchMedia("(orientation: landscape)").matches)) {
        if (activeSizePicker && !e.target.closest('.size-picker-dropdown')) {
            closeAllSizePickers();
        }
    }
    // Mobile portrait: close when clicking overlay
    else if (window.innerWidth <= 768 && window.matchMedia("(orientation: portrait)").matches) {
        if (e.target.classList.contains('size-overlay')) {
            closeAllSizePickers();
        }
    }
});

// Close size picker with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && activeSizePicker) {
        closeAllSizePickers();
    }
});

// ============================================
// IMAGE MODAL FUNCTIONS
// ============================================

/**
 * Opens the image modal with the clicked image
 * @param src - The source URL of the image to display
 */
function openImageModal(src) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    modalImg.src = src;
    modalImg.classList.remove("zoomed");
    modal.style.display = "block";
}

/**
 * Stores image array for current product when opening modal
 */
let currentModalImages = [];
let currentModalIndex = 0;

/**
 * Opens the image modal with navigation arrows if multiple images exist
 * @param src - The source URL of the image to display
 * @param productCard - The product card element (optional, for getting thumbnails)
 */
function openImageModal(src) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    
    // Get all thumbnails from the current product
    const productCard = modalImg.closest('.product-card') || 
                       document.querySelector(`[data-img="${src}"]`) ||
                       document.querySelector(`img[src="${src}"]`)?.closest('.product-card');
    
    // Reset modal state
    modalImg.classList.remove("zoomed");
    modalImg.src = src;
    modal.style.display = "block";
    
    // Get all images for this product
    currentModalImages = [];
    currentModalIndex = 0;
    
    if (productCard) {
        // Get main image
        const mainImg = productCard.querySelector('.main-image img');
        if (mainImg && mainImg.src) {
            currentModalImages.push(mainImg.src);
        }
        
        // Get all thumbnail images
        const thumbnails = productCard.querySelectorAll('.thumbnail-img');
        thumbnails.forEach(thumb => {
            if (thumb.src && !currentModalImages.includes(thumb.src)) {
                currentModalImages.push(thumb.src);
            }
        });
        
        // Find current image index
        currentModalIndex = currentModalImages.findIndex(img => img === src);
        if (currentModalIndex === -1) currentModalIndex = 0;
    }
    
    // Show/hide arrows based on number of images
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    
    if (currentModalImages.length > 1) {
        prevBtn.style.display = "block";
        nextBtn.style.display = "block";
    } else {
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
    }
}

/**
 * Changes image in modal by direction (-1 for previous, 1 for next)
 * @param direction - -1 for previous, 1 for next
 */
function changeModalImage(direction) {
    if (currentModalImages.length === 0) return;
    
    currentModalIndex += direction;
    
    // Handle wrapping
    if (currentModalIndex < 0) {
        currentModalIndex = currentModalImages.length - 1;
    } else if (currentModalIndex >= currentModalImages.length) {
        currentModalIndex = 0;
    }
    
    const modalImg = document.getElementById("modalImg");
    modalImg.src = currentModalImages[currentModalIndex];
    modalImg.classList.remove("zoomed");
}

/**
 * Handle keyboard navigation (left/right arrows)
 */
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById("imageModal");
    if (modal.style.display === "block") {
        if (e.key === "ArrowLeft") {
            changeModalImage(-1);
        } else if (e.key === "ArrowRight") {
            changeModalImage(1);
        } else if (e.key === "Escape") {
            modal.style.display = "none";
        }
    }
});

/**
 * Toggles zoom on the modal image when clicked
 * @param e - The click event
 */
function toggleZoom(e) {
    e.stopPropagation();
    e.target.classList.toggle("zoomed");
}

/**
 * Handles background click to close the image modal
 * @param e - The click event
 */
function handleBackgroundClick(e) {
    if(e.target.id === "imageModal") {
        e.target.style.display = "none";
    }
}

/**
 * Updates the main product image when a thumbnail is clicked
 * @param t - The thumbnail element that was clicked
 */
function updateMainImage(t) {
    const mainImg = document.getElementById(t.dataset.mainId);
    if(mainImg) {
        mainImg.src = t.dataset.fullSrc;
    }
}

// ============================================
// CHECKOUT MODAL FUNCTIONS
// ============================================

/**
 * Opens the checkout modal and renders cart contents
 */
function openCheckoutModal() {
    const modal = document.getElementById("checkoutModal");
    modal.style.display = "block";
    renderCheckout();
}

/**
 * Closes the checkout modal
 */
function closeCheckoutModal() {
    const modal = document.getElementById("checkoutModal");
    modal.style.display = "none";
    document.body.style.overflow = "auto"; // Re-enable scrolling
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById("checkoutModal");
    if (event.target == modal) {
        closeCheckoutModal();
    }
};

// ============================================
// CART MANAGEMENT FUNCTIONS
// ============================================

/**
 * Updates the cart UI with current cart count
 */
function updateCartUI() { 
    document.getElementById("cartCount").textContent = cart.reduce(function(acc, i) { 
        return acc + parseInt(i.qty); 
    }, 0);
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
}

/**
 * Adds a product to the shopping cart
 * @param pid - The product ID to add to cart
 */
function addToCart(pid) {
    const card = document.getElementById(pid).closest('.product-card');
    const qty = parseInt(document.getElementById("qty-"+pid).value);
    
    // Get selected size using new size picker
    let selectedSize = "";
    const sizeContainer = document.getElementById("size-container-" + pid);
    
    // Check if there's a size picker (new method)
    const sizePicker = sizeContainer.querySelector('.size-picker');
    
    if (sizePicker) {
        // Has size picker - user MUST select a size
        selectedSize = getSelectedSize(pid);
        if (!selectedSize) {
            showElegantAlert("Size Required", "<span style='color: #ff4d4d; font-weight: 600;'>Please select a size before adding to cart.</span>", "");
            
            // Open the size picker automatically on mobile
            if (window.innerWidth <= 768) {
                openSizePicker(pid);
            }
            
            return;
        }
    } else {
        // No size picker - it's text like "Sizes (US): N/A" (fallback)
        const sizeText = sizeContainer.textContent || "";
        // Extract just the size value after "Sizes (US):"
        selectedSize = sizeText.replace("Sizes (US):", "").trim();
        if (!selectedSize || selectedSize === "") {
            selectedSize = "N/A";
        }
    }
    
    const existingIndex = cart.findIndex(i => i.id === pid && i.size === selectedSize);
    
    if(existingIndex !== -1) {
        cart[existingIndex].qty += qty;
    } else {
        cart.push({
            id: pid, 
            name: card.querySelector('.product-name').textContent, 
            brand: card.dataset.brand || "", 
            price: card.dataset.price, 
            weight: card.dataset.weight, 
            img: card.dataset.img, 
            qty: qty, 
            sku: card.dataset.sku,
            size: selectedSize  // Add size to cart item
        });
    }
    
    updateCartUI();
    showNotification("Item added to cart!"); 
}

/**
 * Shows a temporary notification that fades in and out
 * @param message - The message to display in the notification
 */
function showNotification(message) {
    // Remove any existing notification
    const existingNotification = document.querySelector('.cart-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification element
    const notification = document.createElement('div');
    notification.className = 'cart-notification';
    notification.innerHTML = `
        <span class="cart-notification-icon"></span>
        <span>${message}</span>
    `;
    
    // Add to DOM
    document.body.appendChild(notification);
    
    // Trigger animation
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // Hide and remove after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        notification.classList.add('hide');
        
        // Remove from DOM after fade out
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

/**
 * Updates quantity in catalog product cards
 * @param pid - Product ID
 * @param change - Amount to change (+1 or -1)
 */
function updateCatalogQty(pid, change) {
    const qtyInput = document.getElementById("qty-" + pid);
    const qtyDisplay = document.getElementById("qty-display-" + pid);
    let currentQty = parseInt(qtyInput.value) || 1;
    if (change === -1 && currentQty <= 1) return;
    const newQty = currentQty + change;
    qtyInput.value = newQty;
    qtyDisplay.textContent = newQty;
}

/**
 * Updates the quantity of a cart item
 * @param idx - The index of the item in the cart array
 * @param change - The amount to change the quantity by (+1 or -1)
 */
function updateQty(idx, change) {
    let currentQty = parseInt(cart[idx].qty) || 1;
    if (change === -1 && currentQty <= 1) return; 
    cart[idx].qty = currentQty + change;
    saveAndRenderCheckout();
}

/**
 * Removes an item from the cart
 * @param idx - The index of the item to remove
 */
function removeItem(idx) { 
    cart.splice(idx, 1); 
    saveAndRenderCheckout();
}

/**
 * Saves cart to localStorage and re-renders checkout
 */
function saveAndRenderCheckout() { 
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart)); 
    updateCartUI();
    renderCheckout();
}

// ============================================
// CATALOG FILTERING & SORTING FUNCTIONS START
// ============================================

/**
 * Sorts products by price (ascending/descending)
 */
function sortByPrice() { 
    // Get all product cards from the DOM
    const container = document.getElementById("container");
    
    // Convert NodeList to array for sorting
    const cardsArray = Array.from(container.children);
    
    // Sort the array by price
    cardsArray.sort((a, b) => {
        const priceA = parseFloat(a.dataset.price) || 0;
        const priceB = parseFloat(b.dataset.price) || 0;
        return asc ? priceA - priceB : priceB - priceA;
    });
    
    // Remove all cards from container
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }
    
    // Re-add all cards in sorted order
    cardsArray.forEach(card => {
        container.appendChild(card);
    });
    
    // Update the allCards array to match new order
    allCards = cardsArray;
    
    // Toggle sort direction for next click
    asc = !asc;
    
    // Re-apply filters to maintain visibility state
    applyFilters();
}

function handleBrandChange() {
    const selectedBrand = getCustomSelectValue("brand");
    
    console.log(` BRAND CHANGED to: ${selectedBrand} - Clearing Sub-brand, Category, Type`);
    
    // Brand clears Sub-brand, Category, Type ONLY
    document.getElementById("subBrandFilter").value = ""; 
    document.getElementById("catFilter").value = ""; 
    document.getElementById("typeFilter").value = ""; 
    
    // Load 8 products
    loadInitialProducts();
    
    // Apply filters
    applyFilters(); 
    
    // Rebuild dropdowns
    rebuildDropdowns();
}

function handleSubBrandChange() {
    const selectedSubBrand = getCustomSelectValue("subBrand");
    console.log(` SUB-BRAND CHANGED to: ${selectedSubBrand} - Clearing Category, Type`);
    
    // Sub-Brand clears Category, Type ONLY
    document.getElementById("catFilter").value = ""; 
    document.getElementById("typeFilter").value = ""; 
    
    // Load 8 products
    loadInitialProducts();
    
    // Apply filters
    applyFilters();
    
    // Rebuild dropdowns
    rebuildDropdowns();
}

function handleCategoryChange() {
    const selectedCategory = getCustomSelectValue("category");
    console.log(` CATEGORY CHANGED to: ${selectedCategory} - Clearing Product Type ONLY`);
    
    // Category only clears Type
    document.getElementById("typeFilter").value = ""; 
    
    // Load products WITH CURRENT FILTERS
    loadInitialProducts();
    
    // Apply filters (will show/hide based on new filters)
    applyFilters(); 
    
    // Rebuild dropdowns
    rebuildDropdowns();
}

function handleTypeChange() {
    // Type clears NOTHING - keep all upstream selections
    console.log(` TYPE CHANGED - No upstream filters cleared`);
   
    // Load 8 products
    loadInitialProducts();
 
    // Apply filters
    applyFilters();
    
    // Rebuild dropdowns
    rebuildDropdowns();
}

function handleSearch() {
    // Search clears NOTHING
    console.log(` SEARCH CHANGED - No filters cleared`);
    
    // Load 8 products
    loadInitialProducts();

    // Apply filters
    applyFilters();
    
    // Rebuild dropdowns
    rebuildDropdowns();
}

// FIX 2: SIMPLIFIED getAvailableOptions - FIX BRANDS ISSUE
function getAvailableOptions() {
    const selectedBrand = getCustomSelectValue("brand");
    const selectedSubBrand = getCustomSelectValue("subBrand");
    const selectedCategory = getCustomSelectValue("category");
    const selectedType = getCustomSelectValue("type");
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    
    const brandSet = new Set();
    const subSet = new Set();
    const catSet = new Set();
    const typeSet = new Set();
    
    if (!window.allProductsData || window.allProductsData.length === 0) {
        return { brandSet, subSet, catSet, typeSet };
    }
    
    console.log("=== FILTER ANALYSIS ===");
    console.log("Current filters:", {
        brand: selectedBrand || "(none)",
        subBrand: selectedSubBrand || "(none)",
        category: selectedCategory || "(none)",
        type: selectedType || "(none)",
        search: searchTerm || "(none)"
    });
    
    // DEBUG: Show all data to understand structure
    console.log("DEBUG - First few products:", window.allProductsData.slice(0, 3));
    
    // ============================================
    // FIX: SIMPLE BRAND COLLECTION - NO COMPLEX LOGIC
    // ============================================
    window.allProductsData.forEach(product => {
        const brand = product.brand || '';
        const source = product.source || '';
        
        // SIMPLE: Always add the display brand from BRAND_NAME_MAP
        if (source && BRAND_NAME_MAP[source]) {
            brandSet.add(BRAND_NAME_MAP[source]);
        }
        // If no mapping, add the brand field
        else if (brand && brand.trim() !== '') {
            brandSet.add(brand);
        }
        // Fallback: add source
        else if (source && source.trim() !== '') {
            brandSet.add(source);
        }
    });
    
    console.log("Brand dropdown options (SIMPLIFIED):", Array.from(brandSet).sort());
    
    // ============================================
    // CATEGORY - BASED ON SELECTED BRAND
    // ============================================
    window.allProductsData.forEach(product => {
        const brand = product.brand || '';
        const source = product.source || '';
        const tag = product.tag || '';
        const category = product.category || '';
        
        if (!category || category.trim() === '') return;
        
        let shouldIncludeCategory = true;
        
        // Get display name for this product
        let productDisplayBrand = '';
        if (source && BRAND_NAME_MAP[source]) {
            productDisplayBrand = BRAND_NAME_MAP[source];
        } else if (brand && brand.trim() !== '') {
            productDisplayBrand = brand;
        } else if (source && source.trim() !== '') {
            productDisplayBrand = source;
        }
        
        // If Brand is selected: Check if product matches
        if (selectedBrand && productDisplayBrand !== selectedBrand) {
            shouldIncludeCategory = false;
        }
        
        // If Sub-brand is selected
        if (selectedSubBrand && tag !== selectedSubBrand) {
            shouldIncludeCategory = false;
        }
        
        if (shouldIncludeCategory) {
            catSet.add(category);
        }
    });
    
    // ============================================
    // TYPE - BASED ON BRAND AND CATEGORY
    // ============================================
    window.allProductsData.forEach(product => {
        const brand = product.brand || '';
        const source = product.source || '';
        const tag = product.tag || '';
        const category = product.category || '';
        const type = product.type || '';
        
        if (!type || type.trim() === '') return;
        
        let shouldIncludeType = true;
        
        // Get display name for this product
        let productDisplayBrand = '';
        if (source && BRAND_NAME_MAP[source]) {
            productDisplayBrand = BRAND_NAME_MAP[source];
        } else if (brand && brand.trim() !== '') {
            productDisplayBrand = brand;
        } else if (source && source.trim() !== '') {
            productDisplayBrand = source;
        }
        
        // Brand filter
        if (selectedBrand && productDisplayBrand !== selectedBrand) {
            shouldIncludeType = false;
        }
        
        // Sub-brand filter
        if (selectedSubBrand && tag !== selectedSubBrand) {
            shouldIncludeType = false;
        }
        
        // Category filter
        if (selectedCategory && category !== selectedCategory) {
            shouldIncludeType = false;
        }
        
        if (shouldIncludeType) {
            typeSet.add(type);
        }
    });
    
    // ============================================
    // SUB-BRANDS - SIMPLIFIED
    // ============================================
    if (SUB_BRAND_ENABLED_GLOBALLY) {
        window.allProductsData.forEach(product => {
            const brand = product.brand || '';
            const source = product.source || '';
            const tag = product.tag || '';
            
            // Only process products from target folders
            if (TARGET_FOLDERS.includes(source)) {
                // Get display name for this product
                let productDisplayBrand = '';
                if (source && BRAND_NAME_MAP[source]) {
                    productDisplayBrand = BRAND_NAME_MAP[source];
                } else if (brand && brand.trim() !== '') {
                    productDisplayBrand = brand;
                } else if (source && source.trim() !== '') {
                    productDisplayBrand = source;
                }
                
                // Check if brand matches selected brand
                let brandMatches = true;
                if (selectedBrand && productDisplayBrand !== selectedBrand) {
                    brandMatches = false;
                }
                
                // Add sub-brand if it exists and is valid
                if (brandMatches && tag && tag.trim() !== '' && !TARGET_FOLDERS.includes(tag)) {
                    subSet.add(tag);
                }
            }
        });
    }
    
    console.log("Available dropdown options:", {
        brands: Array.from(brandSet).sort(),
        subBrands: Array.from(subSet).sort(),
        categories: Array.from(catSet).sort(),
        types: Array.from(typeSet).sort()
    });
    
    // DEBUG: Check what brands are being collected
    console.log("DEBUG - Brands being collected:");
    const brandDebug = new Set();
    window.allProductsData.forEach(product => {
        brandDebug.add(`source="${product.source}", brand="${product.brand}", BRAND_NAME_MAP="${BRAND_NAME_MAP[product.source]}"`);
    });
    console.log(Array.from(brandDebug).slice(0, 10));
    
    console.log("=== END FILTER ANALYSIS ===");
    
    return { brandSet, subSet, catSet, typeSet };
}

// UPDATED DROPDOWN POPULATION FOR CUSTOM SELECTORS
function populateCustomSelectWithOptions(type, set, currentVal) {
    const options = Array.from(set)
        .filter(val => val && val.trim() !== '')
        .sort((a, b) => a.localeCompare(b))
        .map(val => ({
            value: val,
            label: val
        }));
    
    populateCustomSelect(type, options, currentVal);
}

function rebuildDropdowns() {
    const selectedBrand = getCustomSelectValue("brand");
    const selectedSubBrand = getCustomSelectValue("subBrand");
    const selectedCategory = getCustomSelectValue("category");
    const selectedType = getCustomSelectValue("type");
    
    const { brandSet, subSet, catSet, typeSet } = getAvailableOptions();
    
    console.log("=== REBUILDING DROPDOWNS ===");
    console.log("Brands available:", Array.from(brandSet));

    // BRAND: Show ALL brands
    populateCustomSelectWithOptions("brand", brandSet, selectedBrand);
    
    // CATEGORY
    populateCustomSelectWithOptions("category", catSet, selectedCategory);
    
    // TYPE
    populateCustomSelectWithOptions("type", typeSet, selectedType);
   
    // SUB-BRAND
    const subEl = document.getElementById("subBrandWrapper");
    
    let shouldShowSubBrand = false;
    if (SUB_BRAND_ENABLED_GLOBALLY && selectedBrand) {
        // Check if selected brand is in TARGET_FOLDERS
        const selectedBrandFolder = Object.entries(BRAND_NAME_MAP).find(([folder, display]) => display === selectedBrand)?.[0] || selectedBrand;
        shouldShowSubBrand = TARGET_FOLDERS.includes(selectedBrandFolder);
    }
    
    if (shouldShowSubBrand && subSet.size > 0) {
        subEl.style.display = "block";
        populateCustomSelectWithOptions("subBrand", subSet, selectedSubBrand);
    } else {
        subEl.style.display = "none";
        document.getElementById("subBrandFilter").value = "";
    }
    
    console.log("=== END REBUILDING ===");
}

// UPDATED APPLY FILTERS - INCLUDES GENDER FILTER
function applyFilters() {
    if (filterTimeout) {
        clearTimeout(filterTimeout);
    }
    
    filterTimeout = setTimeout(() => {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
              brandFilter = getCustomSelectValue("brand"),
              subBrandFilter = getCustomSelectValue("subBrand"),
              categoryFilter = getCustomSelectValue("category"),
              typeFilter = getCustomSelectValue("type");

        console.log("=== APPLYING FILTERS ===");
        console.log("Active gender filter:", activeGenderFilter);
        
        let visibleCount = 0;
        
        allCards.forEach(card => {
            const productName = card.dataset.name || '';
            const sku = card.dataset.sku || '';
            const brand = card.dataset.brand || '';
            const tag = card.dataset.tag || '';
            const category = card.dataset.category || '';
            const type = card.dataset.type || '';
            const gender = card.dataset.gender || '';
            const source = card.dataset.source || '';
            
            // Get display name
            let displayName = '';
            if (source && BRAND_NAME_MAP[source]) {
                displayName = BRAND_NAME_MAP[source];
            } else if (brand && brand.trim() !== '') {
                displayName = brand;
            } else if (source && source.trim() !== '') {
                displayName = source;
            }
            
            // Check search
            let matchesSearch = true;
            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(word => word.length > 0);
                const productText = (productName + ' ' + sku).toLowerCase();
                matchesSearch = searchWords.every(word => productText.includes(word));
            }
            
            // Check brand (use display name)
            const matchesBrand = !brandFilter || displayName === brandFilter;
            const matchesSubBrand = !subBrandFilter || tag === subBrandFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesType = !typeFilter || type === typeFilter;
            
            // NEW: Check gender filter using new For Her/For Him logic
            const matchesGender = matchesGenderFilter(gender);

            if (matchesSearch && matchesBrand && matchesSubBrand && matchesCategory && matchesType && matchesGender) {
                card.style.display = "flex";
                visibleCount++;
            } else {
                card.style.display = "none";
            }
        });

        console.log(`Visible products: ${visibleCount}`);
        
        updateLoadMoreVisibility();
    }, 300);
}

// FIX: Proper initial product loading with gender filter
function loadInitialProducts() {
    const container = document.getElementById("container");
    const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
          brandFilter = getCustomSelectValue("brand"),
          subBrandFilter = getCustomSelectValue("subBrand"),
          categoryFilter = getCustomSelectValue("category"),
          typeFilter = getCustomSelectValue("type");
    
    if (!window.allProductsData || window.allProductsData.length === 0) {
        console.log("No product data available");
        return;
    }
    
    console.log(` Loading initial products...`);
    
    // CLEAR THE CONTAINER FIRST
    container.innerHTML = '';
    loadedProductIds.clear();
    
    let matchingProducts = [];
    
    // FIRST: Find ALL products that match filters
    for (const product of window.allProductsData) {
        const productName = product.name ? product.name.toLowerCase() : '';
        const sku = product.sku ? product.sku.toLowerCase() : '';
        const brand = BRAND_NAME_MAP[product.source] || product.source || '';
        const tag = product.tag || '';
        const category = product.category || '';
        const type = product.type || '';
        const gender = product.gender || '';
        
        // Check if product matches ALL current filters
        const matchesSearch = !searchTerm || 
            productName.includes(searchTerm) || 
            (sku && sku.includes(searchTerm));
        const matchesBrand = !brandFilter || brand === brandFilter;
        const matchesSubBrand = !subBrandFilter || tag === subBrandFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesType = !typeFilter || type === typeFilter;
        
        // NEW: Check gender filter
        const matchesGender = matchesGenderFilter(gender);

        if (matchesSearch && matchesBrand && matchesSubBrand && matchesCategory && matchesType && matchesGender) {
            matchingProducts.push(product);
        }
    }
    
    console.log(`Found ${matchingProducts.length} matching products`);
    
    // CRITICAL FIX: Load whatever we found, even if less than INITIAL_PRODUCT_LOAD
    const productsToLoad = matchingProducts.slice(0, INITIAL_PRODUCT_LOAD);
    
    if (productsToLoad.length === 0) {
        console.log(" No products match the current filters!");
        // Optionally show a message to the user
        container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No products match the selected filters.</p>';
    } else {
        productsToLoad.forEach(product => {
            const cardHtml = createProductCard(product);
            container.insertAdjacentHTML('beforeend', cardHtml);
            loadedProductIds.add(product.id);
        });
        
        // Update allCards array
        allCards = Array.from(container.children);
        initialLoadComplete = true;
        
        console.log(` Loaded ${productsToLoad.length} initial products (matching filters)`);
    }
    
    // Update Load More button visibility
    updateLoadMoreVisibility();
}

/**
 * Updates visibility of the Load More button
 */
function updateLoadMoreVisibility() {
    if(!ENABLE_BUTTON_LOAD) return;
    
    const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
          brandFilter = getCustomSelectValue("brand"),
          subBrandFilter = getCustomSelectValue("subBrand"),
          categoryFilter = getCustomSelectValue("category"),
          typeFilter = getCustomSelectValue("type");

    let hiddenMatchingCount = 0;
    
    // Check if data is loaded
    if (!window.allProductsData || window.allProductsData.length === 0) {
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        if (loadMoreBtn) loadMoreBtn.style.display = "none";
        return;
    }
    
    // Check all products in JSON data
    window.allProductsData.forEach(product => {
        // Skip if already loaded
        if (loadedProductIds.has(product.id)) return;
        
        const productName = product.name ? product.name.toLowerCase() : '';
        const sku = product.sku ? product.sku.toLowerCase() : '';
        const brand = BRAND_NAME_MAP[product.source] || product.source || '';
        const tag = product.tag || '';
        const category = product.category || '';
        const type = product.type || '';
        const gender = product.gender || '';
        
        // Check gender FIRST
        if (!matchesGenderFilter(gender)) {
            return;
        }
        
        const matchesSearch = !searchTerm || 
            productName.includes(searchTerm) || 
            (sku && sku.includes(searchTerm));
        const matchesBrand = !brandFilter || brand === brandFilter;
        const matchesSubBrand = !subBrandFilter || tag === subBrandFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesType = !typeFilter || type === typeFilter;

        if (matchesSearch && matchesBrand && matchesSubBrand && matchesCategory && matchesType) {
            hiddenMatchingCount++;
        }
    });

    const loadMoreBtn = document.getElementById("loadMoreBtn");
    if (loadMoreBtn) {
        loadMoreBtn.style.display = hiddenMatchingCount > 0 ? "inline-block" : "none";
    }
}

function loadMore(batchSize = LOAD_MORE_BATCH) {
    loadMoreDynamic(batchSize);
}

/**
 * Loads more products dynamically
 */
function loadMoreDynamic(batchSize = LOAD_MORE_BATCH) {
    if (!ENABLE_BUTTON_LOAD) return;
    
    const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
          brandFilter = getCustomSelectValue("brand"),
          subBrandFilter = getCustomSelectValue("subBrand"),
          categoryFilter = getCustomSelectValue("category"),
          typeFilter = getCustomSelectValue("type");

    let loadedCount = 0;
    const container = document.getElementById("container");
    
    // Check if data is loaded
    if (!window.allProductsData || window.allProductsData.length === 0) {
        console.log("Cannot load more products: no data available");
        return;
    }
    
    console.log(` Loading more products matching current filters...`);
    
    // Find products that match ALL current filters
    for (const product of window.allProductsData) {
        if (loadedCount >= batchSize) break;
        
        // Skip if already loaded
        if (loadedProductIds.has(product.id)) {
            continue;
        }
        
        const productName = product.name ? product.name.toLowerCase() : '';
        const sku = product.sku ? product.sku.toLowerCase() : '';
        const brand = BRAND_NAME_MAP[product.source] || product.source || '';
        const tag = product.tag || '';
        const category = product.category || '';
        const type = product.type || '';
        const gender = product.gender || '';
        
        // Check if product matches ALL current filters
        const matchesSearch = !searchTerm || 
            productName.includes(searchTerm) || 
            (sku && sku.includes(searchTerm));
        const matchesBrand = !brandFilter || brand === brandFilter;
        const matchesSubBrand = !subBrandFilter || tag === subBrandFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesType = !typeFilter || type === typeFilter;
        
        // NEW: Check gender filter
        const matchesGender = matchesGenderFilter(gender);

        if (matchesSearch && matchesBrand && matchesSubBrand && matchesCategory && matchesType && matchesGender) {
            // Create and append the product card
            const cardHtml = createProductCard(product);
            container.insertAdjacentHTML('beforeend', cardHtml);
            
            loadedProductIds.add(product.id);
            loadedCount++;
        }
    }

    if (loadedCount > 0) {
        // Update the allCards array with newly loaded cards
        const newCards = Array.from(container.children).slice(-loadedCount);
        allCards = allCards.concat(newCards);
        
        console.log(` Successfully loaded ${loadedCount} more products matching filters`);
        
        // Apply filters to the newly loaded cards
        applyFilters();
        updateLoadMoreVisibility();
    } else {
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        if (loadMoreBtn) {
            loadMoreBtn.style.display = "none";
            console.log(" No more matching products to load");
        }
    }
}

function checkScrollAndLoad() {
    if (!ENABLE_SCROLL_LOAD) return;
    
    const scrollPosition = window.innerHeight + window.scrollY;
    const totalHeight = document.body.offsetHeight;
    const threshold = 300; // Load when 300px from bottom
    
    // Check if we're near the bottom
    if (scrollPosition >= totalHeight - threshold) {
        loadMoreDynamic(LOAD_MORE_BATCH);
    }
}

// Throttle the scroll check
const throttledScrollCheck = throttle(checkScrollAndLoad, 200);

function createProductCard(product) {
    const productId = product.id || ('prod-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
    const p_sizes = product.sizes || "N/A";
    
    // Apply brand mapping
    const displayBrand = BRAND_NAME_MAP[product.source] || product.source || product.brand || '';
    
    let sizes_list = [];
    if (p_sizes && p_sizes.toLowerCase() !== 'n/a' && p_sizes.includes(',')) {
        sizes_list = p_sizes.split(',').map(s => s.trim()).filter(s => s);
    }
    
    let size_picker_html = '';
    if (sizes_list.length > 0) {
        const sizes_attr = sizes_list.join(',');
        const size_options_html = sizes_list.map(size => 
            '<div class="size-option" data-size="' + size + '" onclick="selectSize(\'' + productId + '\', \'' + size + '\')">' + size + '</div>'
        ).join('');
        
        size_picker_html = '<div class="size-picker" data-product-id="' + productId + '" data-sizes="' + sizes_attr + '">' +
            '<div class="size-picker-trigger" onclick="openSizePicker(\'' + productId + '\')">' +
                '<span class="size-placeholder">Select Size</span>' +
                '<span class="size-arrow"></span>' +
            '</div>' +
            '<div class="size-picker-dropdown" id="size-picker-' + productId + '">' +
                '<div class="size-picker-header">' +
                    '<span>Select Size (US)</span>' +
                    '<button class="size-picker-close" onclick="closeSizePicker(\'' + productId + '\')"></button>' +
                '</div>' +
                '<div class="size-picker-options">' +
                    size_options_html +
                '</div>' +
            '</div>' +
            '<input type="hidden" id="selected-size-' + productId + '" value="">' +
        '</div>';
    } else {
        size_picker_html = '<span style="font-size: 0.70em; font-family: ' + CATALOG_SETTINGS["PRODUCT_NAME_FONT_FAMILY"] + '; color: #555; margin: 0; padding: 0;">Sizes (US): ' + p_sizes + '</span>';
    }
    
    const price_display = product.price_display || ('$' + (product.price?.toFixed(2) || '0.00'));
    const original_price = product.original_price || "N/A";
    
    let p_html = '<span style="color: ' + CATALOG_SETTINGS["MAIN_PRICE_COLOR"] + '; font-weight:bold;">' + price_display + '</span>';
    if (original_price !== "N/A" && original_price !== price_display) {
        p_html += ' <s style="color:' + CATALOG_SETTINGS["DISCOUNTED_PRICE_COLOR"] + '; font-size:0.85em; margin-left:5px;">' + original_price + '</s>';
    }
    
    const image_list = product.image_list || '';
    
    return '<div class="product-card" data-sku="' + product.sku + '" data-name="' + product.name.toLowerCase() + '" data-price="' + product.price + '" data-weight="' + product.weight + '" data-category="' + product.category + '" data-gender="' + product.gender + '" data-type="' + product.type + '" data-brand="' + displayBrand + '" data-tag="' + product.tag + '" data-source="' + product.source + '" data-img="' + product.image + '">' +
        '<div class="folder-tag">' + product.tag + '</div>' +
        '<div class="main-image"><img id="' + productId + '" src="' + product.image + '" onclick="openImageModal(this.src)"></div>' +
        '<div class="thumbnails">' + image_list + '</div>' +
        '<div class="product-info">' +
            '<h4 class="product-name">' + product.name + '</h4>' +
            '<div style="display: flex; justify-content: space-between; align-items: center; margin: 2px 0; gap: 10px;">' +
                '<div style="flex-shrink: 0; display: flex; align-items: center; justify-content: flex-start;" id="size-container-' + productId + '">' +
                    size_picker_html +
                '</div>' +
                '<div style="margin-left: auto; flex-shrink: 0;">' +
                    '<div class="qty-controls">' +
                        '<button class="qty-btn" onclick="updateCatalogQty(\'' + productId + '\', -1)">-</button>' +
                        '<span style="font-size: 0.8em; font-weight: 600;" id="qty-display-' + productId + '">1</span>' +
                        '<button class="qty-btn" onclick="updateCatalogQty(\'' + productId + '\', 1)">+</button>' +
                        '<input type="hidden" value="1" id="qty-' + productId + '">' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 8px;">' +
                '<div class="product-price">' + p_html + '</div>' +
                '<button onclick="addToCart(\'' + productId + '\')" style="background:#28a745; color:white; border:none; padding:4px 12px; font-size:0.7em; font-weight:bold; border-radius:3px; cursor:pointer;">Add</button>' +
            '</div>' +
        '</div>' +
    '</div>';
}

/**
 * Resets the catalog to show only initial products
 */
function resetToInitialView() {
    const container = document.getElementById("container");
    
    // If we already have 8 or fewer products loaded, no need to reset
    if (loadedProductIds.size <= INITIAL_PRODUCT_LOAD) return;
    
    console.log(" Resetting to initial view (8 products)");
    
    // Keep track of which products should remain visible
    const visibleProductIds = new Set();
    const productsToKeep = [];
    
    // First, identify which products match current filters
    const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
          brandFilter = getCustomSelectValue("brand"),
          subBrandFilter = getCustomSelectValue("subBrand"),
          categoryFilter = getCustomSelectValue("category"),
          typeFilter = getCustomSelectValue("type");
    
    let keptCount = 0;
    
    // Find the first 8 products that match current filters
    for (const card of allCards) {
        if (keptCount >= INITIAL_PRODUCT_LOAD) break;
        
        const productName = card.dataset.name || '';
        const sku = card.dataset.sku || '';
        const brand = card.dataset.brand || '';
        const tag = card.dataset.tag || '';
        const category = card.dataset.category || '';
        const type = card.dataset.type || '';
        const gender = card.dataset.gender || '';
        
        const matchesSearch = !searchTerm || 
            productName.includes(searchTerm) || 
            (sku && sku.includes(searchTerm));
        const matchesBrand = !brandFilter || brand === brandFilter;
        const matchesSubBrand = !subBrandFilter || tag === subBrandFilter;
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesType = !typeFilter || type === typeFilter;
        
        // NEW: Check gender filter
        const matchesGender = matchesGenderFilter(gender);

        if (matchesSearch && matchesBrand && matchesSubBrand && matchesCategory && matchesType && matchesGender) {
            const productId = card.querySelector('.main-image img')?.id;
            if (productId) {
                visibleProductIds.add(productId);
                productsToKeep.push(card);
                keptCount++;
            }
        }
    }
    
    // Clear the container
    container.innerHTML = '';
    
    // Re-add only the products to keep
    productsToKeep.forEach(card => {
        container.appendChild(card);
    });
    
    // Update loadedProductIds to only include kept products
    loadedProductIds.clear();
    visibleProductIds.forEach(id => loadedProductIds.add(id));
    
    // Update allCards array
    allCards = Array.from(container.children);
    
    console.log(` Reset complete: ${keptCount} products kept`);
}

/**
 * Checks if all filters are cleared and resets view if needed
 */
function checkAndResetIfFiltersCleared() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase(),
          brandFilter = getCustomSelectValue("brand"),
          subBrandFilter = getCustomSelectValue("subBrand"),
          categoryFilter = getCustomSelectValue("category"),
          typeFilter = getCustomSelectValue("type");
    
    // Check if ALL filters are empty/cleared
    const allFiltersEmpty = !searchTerm && 
                          !brandFilter && 
                          !subBrandFilter && 
                          !categoryFilter && 
                          !typeFilter;
    
    if (allFiltersEmpty) {
        // Check if we have more than initial products loaded
        if (loadedProductIds.size > INITIAL_PRODUCT_LOAD) {
            resetToInitialView();
            updateLoadMoreVisibility();
        }
    }
}

// ============================================
// CHECKOUT FUNCTIONS
// ============================================

/**
 * Displays service fee information in an alert
 */
function showServiceInfo() {
    alert("This fee covers processing and handling. For COD orders, it must be paid in advance. For more information please visit https://veloxxa.com/pages/shipping-payment");
}

/**
 * Initializes country dropdown in checkout form
 */
function initCountries() {
    const select = document.getElementById("country");
    if (!SHIPPING_CONFIG.AVAILABLE_COUNTRIES) return;
    SHIPPING_CONFIG.AVAILABLE_COUNTRIES.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c; 
        opt.textContent = c;
        select.appendChild(opt);
    });
}

/**
 * Toggles Cash on Delivery (COD) option based on selected country
 */
function toggleCOD() {
    const selectedCountry = document.getElementById("country").value;
    const codRow = document.getElementById("cod_row");
    if (SHIPPING_CONFIG.COD_COUNTRIES && SHIPPING_CONFIG.COD_COUNTRIES.includes(selectedCountry)) {
        codRow.style.display = "flex";
    } else {
        codRow.style.display = "none";
        if(document.getElementById("radio_cod").checked) setPaymentMethod('card');
    }
}

/**
 * Sets the active payment method and shows/hides relevant sections
 * @param method - Payment method: 'card', 'cod', or 'crypto'
 */
function setPaymentMethod(method) {
    const sections = ['card_section', 'cod_card_section', 'crypto_section'];
    sections.forEach(s => document.getElementById(s).classList.remove("active"));
    
    if (method === 'card') {
        document.getElementById("radio_card").checked = true;
        // document.getElementById("card_section").classList.add("active");
    } else if (method === 'cod') {
        document.getElementById("radio_cod").checked = true;
        document.getElementById("cod_card_section").classList.add("active");
    } else if (method === 'crypto') {
        document.getElementById("radio_crypto").checked = true;
        document.getElementById("crypto_section").classList.add("active");
    }
    
    updateCompleteButtonText();
    renderCheckout(); // ADD THIS LINE to update COD breakdown
}

/**
 * Updates the Complete Request button text based on selected payment method
 */
function updateCompleteButtonText() {
    const btn = document.querySelector('.complete-btn');
    if (!btn) return;
    
    const isCard = document.getElementById("radio_card")?.checked;
    const isCrypto = document.getElementById("radio_crypto")?.checked;
    const isCOD = document.getElementById("radio_cod")?.checked;
    const codSubMethod = document.querySelector('#bubble_card.selected') ? 'card' : 
                        document.querySelector('#bubble_crypto.selected') ? 'crypto' : null;
    
    if ((isCard) || (isCOD && codSubMethod === 'card')) {
        btn.textContent = 'Complete Request & Go to Payment';
    } else {
        btn.textContent = 'Complete Request';
    }
}

/**
 * Sets the COD sub-method (card or crypto) for deposit payment
 * @param sub - Sub-method: 'card' or 'crypto'
 */
function setCODSubMethod(sub) {
    codSubMethod = sub;
    document.getElementById("cod_sub_card").style.display = (sub === 'card') ? "block" : "none";
    document.getElementById("cod_sub_crypto").style.display = (sub === 'crypto') ? "block" : "none";
    document.getElementById("bubble_card").classList.toggle("selected", sub === 'card');
    document.getElementById("bubble_crypto").classList.toggle("selected", sub === 'crypto');

    updateCompleteButtonText();
    renderCheckout();
}

/**
 * Selects a shipping method and updates pricing
 * @param id - Shipping method ID
 */
function selectShipping(id) {
    selectedShippingId = id;
    renderCheckout();
}

/**
 * Shows cryptocurrency address for the selected coin
 * @param coinID - The cryptocurrency identifier
 */
function showCryptoAddr(coinID) {
    const allAddr = document.querySelectorAll(".crypto-address-inline");
    allAddr.forEach(a => a.style.display = "none");
    const target = document.getElementById("addr_" + coinID);
    if(target) target.style.display = "inline-block";
}

/**
 * Renders the checkout interface with cart contents and pricing
 */
function renderCheckout() {
    const list = document.getElementById("cartList");
    let subtotal = 0;
    let totalWeight = 0;
    list.innerHTML = "";
    
    if(cart.length === 0) { 
        list.innerHTML = "<p style='text-align:center; padding: 20px; color: #999;'>Your cart is empty.</p>"; 
    }

    cart.forEach((item, idx) => {
        const price = parseFloat(item.price) || 0;
        const qty = parseInt(item.qty) || 1;
        const weight = parseFloat(item.weight) || 1.0;
        const lineTotal = price * qty;
        subtotal += lineTotal;
        totalWeight += (weight * qty);

        list.innerHTML += `<div class="cart-item">
            <img src="${item.img || ''}">
            <div class="item-info">
                <div class="item-title">${item.name}</div>
                ${item.brand ? `<div style="font-size: 0.7em; color: #666; margin: 2px 0;">Brand: ${item.brand}</div>` : ''}
                <div class="item-meta">
                    ${formatCurrency(price)}
                    ${item.size && item.size !== "N/A" ? `<br>Size: ${item.size}` : ''}
                </div>
                <div class="qty-controls">
                    <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
                    <span style="font-size: 0.8em; font-weight: 600;">${qty}</span>
                    <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                </div>
            </div>
            <div style="text-align: right; width: 70px; flex-shrink: 0;">
                <button onclick="removeItem(${idx})" style="color:#cc0000; border:none; background:none; cursor:pointer; font-size: 0.75em;">Remove </button>
                <div style="font-weight:bold; font-size:0.9em; margin-top:5px;">${formatCurrency(lineTotal)}</div>
            </div>
        </div>`;
    });

    // Weight-Based Logic for Shipping
    let activePrice = 0;
    const shipContainer = document.getElementById("shipping_methods_container");
    shipContainer.innerHTML = "";

    if (SHIPPING_CONFIG.SHIPPING_METHODS) {
        SHIPPING_CONFIG.SHIPPING_METHODS.forEach(m => {
            let cost = m.price;
            let isDisabled = false;
            let standardNote = "";
            
            // Calculate Express Tiers
            if (m.id === 'express' && SHIPPING_CONFIG.EXPRESS_TIERS) {
                const tier = SHIPPING_CONFIG.EXPRESS_TIERS.find(t => totalWeight <= t.max_w);
                cost = tier ? tier.price : SHIPPING_CONFIG.EXPRESS_TIERS[SHIPPING_CONFIG.EXPRESS_TIERS.length-1].price;
            }

            // Standard Shipping Rules & Note
            if (m.id === 'standard') {
                const priceMet = subtotal >= SHIPPING_CONFIG.FREE_SHIPPING_THRESHOLD;
                const weightMet = totalWeight <= SHIPPING_CONFIG.FREE_MAX_WEIGHT;
                
                standardNote = `<div style="font-size: 0.7em; color: #888; margin-top: 5px; font-style: italic;">
                    Note: Each pair of shoes is considered ~1.8kg for calculation.
                </div>`;
                
                if (priceMet && weightMet) {
                    cost = 0;
                } else {
                    isDisabled = true;
                    cost = 0;
                    standardNote += `<div style="color: #ff4d4d; font-size: 0.8em; margin-top: 5px; font-weight: 600;">
                        Locked: Requires ${formatCurrency(SHIPPING_CONFIG.FREE_SHIPPING_THRESHOLD)}+ and under ${SHIPPING_CONFIG.FREE_MAX_WEIGHT}kg. Excluding shipping cost. (Current: ${formatCurrency(subtotal)} / ${totalWeight.toFixed(1)}kg)
                    </div>`;
                }
            }

            // Selection & Fallback Logic
            if(selectedShippingId === m.id) {
                if (isDisabled) {
                    selectedShippingId = null;
                    activePrice = 0;
                    shippingMethodName = "Shipping";
                } else {
                    activePrice = cost;
                    shippingMethodName = m.name; 
                }
            }

            // Render the Row
            shipContainer.innerHTML += `
                <div class="shipping-method-row ${selectedShippingId === m.id ? 'selected' : ''} ${isDisabled ? 'disabled-method' : ''}" 
                     ${isDisabled ? '' : `onclick="selectShipping('${m.id}')"`}
                     style="${isDisabled ? 'opacity: 0.6; cursor: not-allowed; background: #f9f9f9;' : ''}">
                    <input type="radio" name="ship_radio" ${selectedShippingId === m.id ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                    <div class="shipping-info">
                        <div class="shipping-name">${m.name} ${isDisabled ? '(Locked)' : ''}</div>
                        <div class="shipping-desc">${m.desc}${standardNote}</div>
                    </div>
                    <div class="shipping-cost">${cost === 0 ? 'FREE' : formatCurrency(cost)}</div>
                </div>`;
        });
    }

    const serviceFee = subtotal * FEE_PERCENT;
    const currentTotal = subtotal + activePrice + serviceFee;
    
    // FIXED: Use formatCurrency() consistently
    document.getElementById("subtotalBox").textContent = formatCurrency(subtotal);
    
    const feeDisplay = document.getElementById("serviceFeeBox");
    
    // NEW: Calculate COD breakdown if COD is selected
    const isCOD = document.getElementById("radio_cod")?.checked;
    const codBreakdown = document.getElementById("codBreakdown");
    
    if (isCOD && codBreakdown) {
        codBreakdown.style.display = "block";
        
        // Calculate amounts
        const dueToday = currentTotal * 0.33; // 33% service fee
        const dueOnDelivery = currentTotal - dueToday;
        
        document.getElementById("dueTodayBox").textContent = formatCurrency(dueToday);
        document.getElementById("dueOnDeliveryBox").textContent = formatCurrency(dueOnDelivery);
        
        // Update service fee display to show amount
        feeDisplay.textContent = "Included";
    } else {
        if (codBreakdown) {
            codBreakdown.style.display = "none";
        }
        
        // Regular service fee display
        if (FEE_PERCENT === 0) {
            feeDisplay.textContent = "Included";
        } else {
            feeDisplay.textContent = formatCurrency(serviceFee);
        }
    }
    
    const sBox = document.getElementById("shippingBox");
    document.getElementById("shippingLabel").textContent = shippingMethodName; 
    sBox.textContent = activePrice === 0 ? "FREE" : formatCurrency(activePrice);
    sBox.style.color = activePrice === 0 ? "#666" : "#333";
    
    // FIXED: Use formatCurrency() for total
    document.getElementById("totalBox").textContent = formatCurrency(currentTotal);
    toggleCOD();
}

/**
 * Processes the order and validates all required information
 */
function processOrder() {
    // Check if shipping method is selected
    if (!selectedShippingId) {
        showElegantAlert("Shipping Required", "Please select a shipping method to continue.", "");
        return;
    }
    
    const isCOD = document.getElementById("radio_cod").checked;
    const isCrypto = document.getElementById("radio_crypto").checked;
    const firstName = document.getElementById("fname").value.trim();
    const lastName = document.getElementById("lname").value.trim();
    
    // Validate cart and required fields
    if(cart.length === 0) { 
        showElegantAlert("Empty Cart", "Your cart is empty. Add some products first!", "");
        return; 
    }
    if(!firstName || !lastName) { 
        showElegantAlert("Name Required", "Please fill in your first and last name.", ""); 
        return; 
    }

    // Validate COD sub-method if COD is selected
    if (isCOD && !codSubMethod) {
        showElegantAlert("Deposit Method Required", "Please select a deposit method (Card or Crypto) for your COD order.", "");
        return;
    }

    /*
    // Validate cardholder name matches billing name for card payments
    let needsCardCheck = (document.getElementById("radio_card").checked || (isCOD && codSubMethod === 'card'));
    if (needsCardCheck) {
        const inputID = (isCOD) ? "cardNameCOD" : "cardName";
        const cardName = document.getElementById(inputID).value.trim();
        if(cardName.toLowerCase() !== (firstName + " " + lastName).toLowerCase()) {
            showElegantAlert("Name Mismatch", "Cardholder name must match the Billing Name exactly.", "");
            return;
        }
    }
    */

    // Show appropriate success message based on payment method
    if(isCOD) {
        alert("Thank you! Order request submitted via COD. Please ensure the deposit is finalized.");
    } else if (isCrypto) {
        alert("Order placed! Please send crypto payment within 24 hours.");
    } else {
        alert("Thank you! Order request submitted via Credit Card.");
    }

    // Create order data object for invoice
    const orderData = {
        name: document.getElementById("fname").value + " " + document.getElementById("lname").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        addr: document.getElementById("addr").value,
        city: document.getElementById("city").value,
        zip: document.getElementById("zip").value,
        country: document.getElementById("country").value,
        items: cart,
        subtotal: document.getElementById("subtotalBox").textContent,
        shipping: document.getElementById("shippingBox").textContent,
        fee: document.getElementById("serviceFeeBox").textContent,
        total: document.getElementById("totalBox").textContent,
        paymentMethod: document.querySelector('input[name="pay_choice"]:checked').parentElement.innerText.trim()
    };

    // Save order to session storage for invoice generation
    sessionStorage.setItem('currentOrder', JSON.stringify(orderData));

    // Close checkout modal after successful order
    closeCheckoutModal();
}

// ============================================
// CURRENCY FORMATTING HELPER
// ============================================
function formatCurrency(amount) {
    if (amount === undefined || amount === null) return "$0.00";
    
    // Convert to number
    let num = typeof amount === 'string' ? 
        parseFloat(amount.replace(/[$,]/g, '')) : 
        Number(amount);
    
    if (isNaN(num)) return "$0.00";
    
    // Format with $, commas, and 2 decimals
    return "$" + num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// ============================================
// ALERTS JAVA
// ============================================

/**
 * Shows an elegant themed alert/modal
 */
function showElegantAlert(title, message, icon = "") {
    // Remove any existing alert
    const existing = document.querySelector('.elegant-alert-overlay');
    if (existing) existing.remove();
    
    const alertHTML = `
        <div class="elegant-alert-overlay">
            <div class="elegant-alert-box">
                <div class="elegant-alert-icon">${icon}</div>
                <div class="elegant-alert-title">${title}</div>
                <div class="elegant-alert-message">${message}</div>
                <button class="elegant-alert-btn" onclick="this.closest('.elegant-alert-overlay').remove()">OK</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    // Auto-close on overlay click
    document.querySelector('.elegant-alert-overlay').addEventListener('click', function(e) {
        if (e.target === this) this.remove();
    });
    
    // Auto-close with Escape key
    const closeOnEscape = (e) => {
        if (e.key === 'Escape') {
            document.querySelector('.elegant-alert-overlay')?.remove();
            document.removeEventListener('keydown', closeOnEscape);
        }
    };
    document.addEventListener('keydown', closeOnEscape);
}


/**
 * Handles payment modal action (open checkout or show invoice)
 */
function handlePaymentModalAction(checkoutUrl, invoiceHTML) {
    if (checkoutUrl) {
        window.open(checkoutUrl, '_blank');
    }
    // Transform current tab into Invoice
    window.history.pushState({page: "invoice"}, "Order Invoice", "#invoice");
    document.body.innerHTML = invoiceHTML;
    window.scrollTo(0, 0);
}

/**
 * Continues shopping by closing the modal
 */
function continueShoppingFromModal() {
    const modal = document.getElementById('payment-modal');
    if (modal) {
        modal.remove();
    }
}

// ============================================
// INITIALIZATION FUNCTIONS
// ============================================

window.onload = async () => {
    console.log("Starting catalog initialization...");
    
    // Load product data from JSON FIRST
    await loadProductData();
    
    // Initialize the allCards array with initially loaded products
    const container = document.getElementById("container");
    allCards = Array.from(container.children);
    
    // Set default gender filter to "For Her" as requested
    setGenderFilter('forHer');
    
    // Load exactly INITIAL_PRODUCT_LOAD products
    loadInitialProducts();
    
    // Apply filters to show initial products
    applyFilters();
    rebuildDropdowns();
    updateCartUI();
    updateLoadMoreVisibility();
    
    // Initialize checkout
    initCountries();
    renderCheckout();
    updateCompleteButtonText(); 
    
    // Initialize scroll loading
    if (ENABLE_SCROLL_LOAD) {
        window.addEventListener('scroll', throttledScrollCheck);
        // Check immediately in case content is short
        setTimeout(() => checkScrollAndLoad(), 1000);
    }
    
    handleResponsiveLayout();
    
    console.log(`Catalog initialized: ${loadedProductIds.size} products loaded, ${window.allProductsData ? window.allProductsData.length : 0} total products available`);
};

// ============================================
// DYNAMIC PRODUCT LOADING FUNCTIONS
// ============================================

let allProductsData = [];
let loadedProductIds = new Set();

/**
 * Loads product data from JSON file
 */
async function loadProductData() {
    try {
        const response = await fetch('products_data.json');
        // Use window scope to avoid duplication
        window.allProductsData = await response.json();
        console.log(`Loaded ${window.allProductsData.length} products from JSON`);
        
        // Mark initial products as loaded
        document.querySelectorAll('.product-card').forEach(card => {
            const productId = card.querySelector('.main-image img').id;
            loadedProductIds.add(productId);
        });
        
        // Initialize dropdowns after loading data
        rebuildDropdowns();
        updateLoadMoreVisibility();
    } catch (error) {
        console.error('Error loading product data:', error);
        // Initialize empty array if fetch fails
        window.allProductsData = [];
        fallbackLoadProductData();
    }
}

/**
 * Creates HTML for a product card
 */
function createProductCard(product) {
    const productId = product.id || `prod-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const p_sizes = product.sizes || "N/A";
    
    // Parse sizes if available
    let sizes_list = [];
    if (p_sizes && p_sizes.toLowerCase() !== 'n/a' && p_sizes.includes(',')) {
        sizes_list = p_sizes.split(',').map(s => s.trim()).filter(s => s);
    }
    
    let size_picker_html = '';
    if (sizes_list.length > 0) {
        const sizes_attr = sizes_list.join(',');
        const size_options_html = sizes_list.map(size => 
            `<div class="size-option" data-size="${size}" onclick="selectSize('${productId}', '${size}')">${size}</div>`
        ).join('');
        
        size_picker_html = `
            <div class="size-picker" data-product-id="${productId}" data-sizes="${sizes_attr}">
                <div class="size-picker-trigger" onclick="openSizePicker('${productId}')">
                    <span class="size-placeholder">Select Size</span>
                    <span class="size-arrow"></span>
                </div>
                <div class="size-picker-dropdown" id="size-picker-${productId}">
                    <div class="size-picker-header">
                        <span>Select Size (US)</span>
                        <button class="size-picker-close" onclick="closeSizePicker('${productId}')"></button>
                    </div>
                    <div class="size-picker-options">
                        ${size_options_html}
                    </div>
                </div>
                <input type="hidden" id="selected-size-${productId}" value="">
            </div>
        `;
    } else {
        size_picker_html = `<span style="font-size: 0.70em; font-family: ${CATALOG_SETTINGS["PRODUCT_NAME_FONT_FAMILY"]}; color: #555; margin: 0; padding: 0;">Sizes (US): ${p_sizes}</span>`;
    }
    
    // Price HTML
    const price_display = product.price_display || `$${product.price?.toFixed(2) || '0.00'}`;
    const original_price = product.original_price || "N/A";
    
    let p_html = `<span style="color: ${CATALOG_SETTINGS["MAIN_PRICE_COLOR"]}; font-weight:bold;">${price_display}</span>`;
    if (original_price !== "N/A" && original_price !== price_display) {
        p_html += ` <s style="color:${CATALOG_SETTINGS["DISCOUNTED_PRICE_COLOR"]}; font-size:0.85em; margin-left:5px;">${original_price}</s>`;
    }
    
    // Thumbnails
    const image_list = product.image_list || '';
    
    return `
    <div class="product-card" data-sku="${product.sku}" data-name="${product.name.toLowerCase()}" data-price="${product.price}" data-weight="${product.weight}" data-category="${product.category}" data-gender="${product.gender}" data-type="${product.type}" data-brand="${product.brand}" data-tag="${product.tag}" data-source="${product.source}" data-img="${product.image}">
        <div class="folder-tag">${product.tag}</div>
        <div class="main-image"><img id="${productId}" src="${product.image}" onclick="openImageModal(this.src)"></div>
        <div class="thumbnails">${image_list}</div>
        <div class="product-info">
            <h4 class="product-name">${product.name}</h4>
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 2px 0; gap: 10px;">
                <div style="flex-shrink: 0; display: flex; align-items: center; justify-content: flex-start;" id="size-container-${productId}">
                    ${size_picker_html}
                </div>
                <div style="margin-left: auto; flex-shrink: 0;">
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateCatalogQty('${productId}', -1)">-</button>
                        <span style="font-size: 0.8em; font-weight: 600;" id="qty-display-${productId}">1</span>
                        <button class="qty-btn" onclick="updateCatalogQty('${productId}', 1)">+</button>
                        <input type="hidden" value="1" id="qty-${productId}">
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 8px;">
                <div class="product-price">${p_html}</div>
                <button onclick="addToCart('${productId}')" style="background:#28a745; color:white; border:none; padding:4px 12px; font-size:0.7em; font-weight:bold; border-radius:3px; cursor:pointer;">Add</button>
            </div>
        </div>
    </div>`;
}

/**
 * Fallback function to load product data from HTML if JSON fails
 */
function fallbackLoadProductData() {
    const container = document.getElementById("container");
    const cards = container.querySelectorAll('.product-card');
    
    cards.forEach(card => {
        const productId = card.querySelector('.main-image img').id;
        const productData = {
            id: productId,
            name: card.querySelector('.product-name')?.textContent || '',
            sku: card.dataset.sku || '',
            brand: card.dataset.brand || '',
            tag: card.dataset.tag || '',
            category: card.dataset.category || '',
            gender: card.dataset.gender || '',
            type: card.dataset.type || '',
            price: parseFloat(card.dataset.price) || 0,
            weight: card.dataset.weight || '1.0',
            source: card.dataset.source || '',
            image: card.dataset.img || ''
        };
        allProductsData.push(productData);
        loadedProductIds.add(productId);
    });
    
    console.log(`Fallback loaded ${allProductsData.length} products from HTML`);
}


/**
 * Handles responsive layout adjustments for mobile/desktop
 */
function handleResponsiveLayout() {
    const isMobilePortrait = window.innerWidth <= 768 && window.matchMedia("(orientation: portrait)").matches;
    
    if (isMobilePortrait) {
        // Mobile portrait layout - 2 columns
        const container = document.getElementById('container');
        container.style.gridTemplateColumns = `repeat(${MOBILE_COLUMNS}, 1fr)`;
        
        // Adjust product cards for better mobile display
        document.querySelectorAll('.product-card').forEach(card => {
            card.style.padding = '12px';
        });
    } else {
        // Desktop OR mobile landscape - use desktop layout (CSS will handle this)
        const container = document.getElementById('container');
        container.style.gridTemplateColumns = ''; // Let CSS handle it
    }
}

// Handle window resize with throttling for better performance
window.addEventListener('resize', throttle(handleResponsiveLayout, 100));

// ============================================
// IMAGE PROTECTION SCRIPT
// ============================================

// Image Protection - Disable Right Click
(function() {
    // Function to protect images
    function protectImages() {
        // Disable right-click on images
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
            }
        });

        // Disable drag/drop of images
        document.addEventListener('dragstart', function(e) {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
            }
        });

        // Disable keyboard shortcuts for saving
        document.addEventListener('keydown', function(e) {
            // Disable Ctrl+S (Windows) or Cmd+S (Mac)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
            }
            
            // Disable Print Screen
            if (e.key === 'PrintScreen') {
                e.preventDefault();
            }
        });

        // CSS to prevent image dragging and selection
        const style = document.createElement('style');
        style.textContent = `
            img {
                pointer-events: none;
                user-select: none;
                -webkit-user-drag: none;
                -moz-user-drag: none;
                -ms-user-drag: none;
                user-drag: none;
            }
        `;
        document.head.appendChild(style);
    }

    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', protectImages);
    } else {
        protectImages();
    }
})();

// ============================================
// GOOGLE APPS SCRIPT + INVOICE LAUNCHER + SHOPIFY LAUNCHER + PREFILL (must be regular checkout pg/not draft)
// ============================================

// GOOGLE APPS SCRIPT ORDER SUBMISSION WITH INVOICE
async function submitOrderToFormspree() {
    const btn = document.querySelector('.complete-btn');
    const originalText = btn.textContent;
    
    // --- 1. CLEAR PREVIOUS ERRORS ---
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

    // --- 2. DATA COLLECTION ---
    const firstName = document.getElementById("fname").value.trim();
    const lNameField = document.getElementById("lname") || document.getElementById("lastName");
    const lastName = lNameField ? lNameField.value.trim() : "";
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const addr = document.getElementById("addr").value.trim();
    const city = document.getElementById("city").value.trim();
    const zip = document.getElementById("zip").value.trim();
    const country = document.getElementById("country").value;
    const marketingOptIn = document.getElementById("marketing_opt_in")?.checked ? 1 : 0;

    // --- 3. DETERMINE PAYMENT METHOD ---
    const isCOD = document.getElementById("radio_cod")?.checked || false;
    const isCrypto = document.getElementById("radio_crypto")?.checked || false;
    const isCard = document.getElementById("radio_card")?.checked || false;
    const codSubMethod = document.querySelector('#bubble_card.selected') ? 'card' : 
                        document.querySelector('#bubble_crypto.selected') ? 'crypto' : null;
    
    // Determine if we need Shopify checkout (Card payments)
    const needsShopifyCheckout = (isCard) || (isCOD && codSubMethod === 'card');
    
    let paymentMethod = "Unknown";
    if (isCOD) {
        paymentMethod = codSubMethod === 'card' ? "COD (Card Deposit)" : "COD (Crypto Deposit)";
    } else if (isCrypto) {
        paymentMethod = "Crypto";
    } else if (isCard) {
        paymentMethod = "Credit Card";
    }
    
    // --- 4. VALIDATION (updated with popup alert) ---
    let isValid = true;
    let missingFields = [];
    
    function showError(id, msg, fieldName) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('input-error');
            const error = document.createElement('div');
            error.className = 'error-message';
            error.style.color = '#ff4d4d';
            error.style.fontSize = '12px';
            error.style.marginTop = '5px';
            error.style.textAlign = 'left';
            error.textContent = msg;
            el.parentNode.appendChild(error);
        }
        isValid = false;
        if (fieldName) missingFields.push(fieldName);
    }

    // Clear previous errors
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    missingFields = [];

    if (!firstName) showError("fname", "First name is required", "First Name");
    if (!lastName) showError(lNameField.id, "Last name is required", "Last Name");
    if (!email || !email.includes("@")) showError("email", "Valid email is required", "Email");
    if (!phone) showError("phone", "Phone number is required", "Phone Number");
    if (!addr) showError("addr", "Shipping address is required", "Shipping Address");
    if (!city) showError("city", "City is required", "City");
    if (!zip) showError("zip", "Zip/Postal code is required", "Zip/Postal Code");
    if (!country) showError("country", "Please select a country", "Country");
    
    if (cart.length === 0) { 
        showElegantAlert("Empty Cart", "Your cart is empty! Add some products first.", "");
        return; 
    }
    
    if (!selectedShippingId) {
        showElegantAlert("Shipping Required", "Please select a shipping method to continue.", "");
        return;
    }

    // Show popup alert if any required fields are missing
    if (!isValid) {
        let errorMessage = '<div style="color: #ff4d4d; font-weight: 600; margin-bottom: 15px; font-size: 1.1em; text-align: center;">Please fill in all required fields:</div>';
        
        // Create a centered formatted list of missing fields in red
        errorMessage += '<div style="color: #ff4d4d; text-align: center; line-height: 1.8;">';
        missingFields.forEach(function(field, index) {
            errorMessage += '<div>' + (index + 1) + '. ' + field + '</div>';
        });
        errorMessage += '</div>';
        
        // Show elegant alert with missing fields
        showElegantAlert("Missing Information", errorMessage, "");
        
        // Scroll to top of checkout modal
        const checkoutModal = document.getElementById("checkoutModal");
        if (checkoutModal) {
            checkoutModal.scrollTop = 0;
        }
        
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Processing...';

    const orderId = 'VX-' + Date.now().toString().slice(-8) + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
    
    // ADD THIS SECTION:
    // Calculate COD amounts if COD is selected
    let dueToday = 0;
    let dueOnDelivery = 0;

    if (isCOD) {
        const currentTotal = parseFloat(document.getElementById("totalBox").textContent.replace(/[$,]/g, ''));
        dueToday = currentTotal * 0.33; // 33% service fee
        dueOnDelivery = currentTotal - dueToday;
    }
    
    try {
        const orderData = {
            orderId: orderId,
            name: `${firstName} ${lastName}`,
            email: email, phone: phone, addr: addr, city: city, zip: zip, country: country,
            items: cart.map(item => ({
                name: item.name, 
                sku: item.sku || "N/A",
                brand: item.brand || "",
                price: parseFloat(item.price) || 0, 
                qty: parseInt(item.qty) || 1, 
                weight: item.weight || 0,
                lineTotal: (parseFloat(item.price) || 0) * (parseInt(item.qty) || 1),
                image: item.img || "",
                size: item.size || "N/A"
            })),
            subtotal: document.getElementById("subtotalBox").textContent,
            shipping: document.getElementById("shippingBox").textContent,
            shippingMethod: shippingMethodName,
            fee: document.getElementById("serviceFeeBox").textContent,
            total: document.getElementById("totalBox").textContent,
            paymentMethod: paymentMethod,
            isCOD: isCOD,
            dueToday: dueToday.toFixed(2), 
            dueOnDelivery: dueOnDelivery.toFixed(2),
            orderDate: new Date().toLocaleString(),
            businessName: "Veloxxa",
            businessEmail: "support@veloxxa.com",
            businessAddress: "Portland, United States",
            businessLogo: "https://veloxxa.com/cdn/shop/files/logo-removebg-preview.png?v=1763035693&width=120"
        };

        // --- 5. SERVER SUBMISSION ---
        let baseCheckoutUrl = null;
        let shopifyErrorMsg = null;

        // ONLY create Shopify checkout for card payments
        if (needsShopifyCheckout) {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyChwRNgvuAeyleWL8ZoBhV2nQIUTIf-BZVEQa29a2GDBWrWwaodm3AUOomkm8fddqC/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ ...orderData, timestamp: new Date().toISOString() })
            });
            
            const result = await response.json();

            if (result.success && result.shopify_response) {
                let sData = result.shopify_response;
                if (typeof sData === 'string') {
                    try { sData = JSON.parse(sData); } catch(e) {}
                }
                
                if (sData && sData.checkout_url) {
                    baseCheckoutUrl = sData.checkout_url;
                } else if (sData && sData.error) {
                    shopifyErrorMsg = "The email domain provided appears invalid. If your order was saved, you will receive a link via email shortly.";
                }
            }
        } else {
            // For crypto payments, just submit to Google Apps Script without Shopify
            await fetch('https://script.google.com/macros/s/AKfycbyChwRNgvuAeyleWL8ZoBhV2nQIUTIf-BZVEQa29a2GDBWrWwaodm3AUOomkm8fddqC/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    ...orderData, 
                    timestamp: new Date().toISOString(),
                    note: "Crypto payment - no Shopify checkout needed"
                })
            });
        }

        // --- 6. CONSTRUCT PREFILL URL (only for card payments) ---
        let finalUrl = baseCheckoutUrl;
        if (baseCheckoutUrl) {
            const params = new URLSearchParams();
            if (email) params.append("checkout[email]", email);
            if (firstName) params.append("checkout[shipping_address][first_name]", firstName);
            if (lastName) params.append("checkout[shipping_address][last_name]", lastName);
            if (addr) params.append("checkout[shipping_address][address1]", addr);
            if (city) params.append("checkout[shipping_address][city]", city);
            if (zip) params.append("checkout[shipping_address][zip]", zip);
            if (country) params.append("checkout[shipping_address][country]", country);
            if (phone) params.append("checkout[shipping_address][phone]", phone);
            params.append("checkout[buyer_accepts_marketing]", marketingOptIn);
            
            finalUrl = `${baseCheckoutUrl}?${params.toString()}`;
        }

        // --- 7. SHOW FINAL MODAL ---
        const invoiceHTML = generateInvoiceHTML(orderData);
        
        if (needsShopifyCheckout) {
            // For card payments: Show modal with payment link
            showPaymentBridgeModal(orderId, finalUrl, invoiceHTML, shopifyErrorMsg);
        } else {
            // For crypto payments: Directly show invoice
            showCryptoSuccessModal(orderId, invoiceHTML);
        }

        // --- 8. CLEANUP ---
        cart = []; 
        localStorage.setItem("catalog_cart", JSON.stringify([]));
        if (typeof updateCartUI === 'function') updateCartUI();
        closeCheckoutModal();

    } catch (err) {
        console.error(err);
        alert("A system error occurred. Please refresh and try again.");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}
function showCryptoSuccessModal(orderId, invoiceHTML) {
    const modalHtml = `
        <div id="crypto-success-modal" class="elegant-alert-overlay">
            <div class="elegant-alert-box" style="max-width: 420px;">
                <div class="elegant-alert-icon"></div>
                <h2 class="elegant-alert-title">Order Confirmed!</h2>
                <p class="elegant-alert-message">
                    Order <strong>${orderId}</strong> has been recorded.<br><br>
                    <span style="color: #ff4d4d; font-weight: 600;">
                        Please send crypto payment within 24 hours.
                    </span><br>
                    Check your invoice for payment details.
                </p>
                <button class="elegant-alert-btn" id="view-invoice-btn">
                    VIEW INVOICE
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    document.getElementById('view-invoice-btn').addEventListener('click', function() {
        // Transform current tab into Invoice
        window.history.pushState({page: "invoice"}, "Order Invoice", "#invoice");
        document.body.innerHTML = invoiceHTML;
        window.scrollTo(0, 0);
    });
}

function showPaymentBridgeModal(orderId, checkoutUrl, invoiceHTML, friendlyError) {
    const old = document.getElementById('payment-modal');
    if (old) old.remove();

    const isSuccess = !!checkoutUrl;
    const modalHtml = `
        <div id="payment-modal" class="elegant-alert-overlay">
            <div class="elegant-alert-box" style="max-width: 420px;">
                <div class="elegant-alert-icon">${isSuccess ? '' : ''}</div>
                <h2 class="elegant-alert-title">${isSuccess ? 'Order Confirmed!' : 'Order Recorded'}</h2>
                <p class="elegant-alert-message">
                    Order <strong>${orderId}</strong> recorded.<br><br>
                    ${friendlyError ? `<span style="color:#ff4d4d; font-weight:600;">${friendlyError}</span>` : "Click below to complete your payment and view your invoice."}
                </p>
                <button class="elegant-alert-btn" id="bridge-btn">
                    ${isSuccess ? 'GO TO PAYMENT PAGE' : 'VIEW INVOICE'}
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    document.getElementById('bridge-btn').addEventListener('click', function() {
        if (checkoutUrl) {
            window.open(checkoutUrl, '_blank');
        }
        // Transform current tab into Invoice (Back-button friendly)
        window.history.pushState({page: "invoice"}, "Order Invoice", "#invoice");
        document.body.innerHTML = invoiceHTML;
        window.scrollTo(0, 0);
    });
}

// GENERATE INVOICE HTML (EXACTLY LIKE YOUR ORIGINAL FORMAT)
function generateInvoiceHTML(orderData) {
    const itemsHTML = orderData.items.map(item => `
        <tr>
            <td>${item.brand ? item.brand + ': ' : ''}${item.name} ${item.size && item.size !== "N/A" ? '(Size: ' + item.size + ')' : ''}</td>
            <td style="text-align: center;">${item.qty}</td>
            <td style="text-align: right;">$${item.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td style="text-align: right;">$${item.lineTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
        </tr>
    `).join('');
    
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Invoice - ${orderData.businessName}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: #fff; 
            margin: 0; 
            padding: 40px; 
            color: #333; 
        }
        .invoice-box { 
            max-width: 800px; 
            margin: auto; 
            border: 1px solid #eee; 
            padding: 30px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.05); 
            background: white;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid #D4AF37; 
            padding-bottom: 20px; 
        }
        .logo { 
            max-width: 120px; 
        }
        .business-info { 
            text-align: right; 
        }
        .business-info h2 {
            margin: 0; 
            color: #000; 
            font-weight: 700;
        }
        
        .details-grid { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 40px; 
            margin-bottom: 40px; 
        }
        .column { 
            flex: 1; 
        }
        .column h4 { 
            text-transform: uppercase; 
            color: #888; 
            font-size: 0.8em; 
            margin-bottom: 10px; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            text-align: left; 
        }
        th { 
            background: #000; 
            color: #D4AF37; 
            padding: 12px; 
            text-transform: uppercase; 
            font-size: 0.8em; 
        }
        td { 
            padding: 12px; 
            border-bottom: 1px solid #eee; 
        }
        
        .totals-section { 
            margin-top: 30px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }
        .total-row { 
            display: grid; 
            grid-template-columns: 160px 100px; 
            text-align: right; 
            padding: 8px 0; 
        }
        .grand-total { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: #D4AF37; 
            border-top: 2px solid #000; 
            padding-top: 10px; 
            margin-top: 10px; 
        }
        
        .footer { 
            margin-top: 50px; 
            text-align: center; 
            font-size: 0.8em; 
            color: #999; 
            border-top: 1px solid #eee; 
            padding-top: 20px; 
        }
        
        @media print { 
            .no-print { display: none; } 
        }
        
        .action-buttons {
            text-align: center; 
            margin-bottom: 30px;
        }
        .action-buttons button {
            background: #000; 
            color: #D4AF37; 
            padding: 12px 24px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            border-radius: 5px;
            margin: 0 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="action-buttons no-print">
        <button onclick="window.print()"> Save as PDF / Print Invoice</button>
        <button onclick="window.close()"> Close Invoice</button>
        <button onclick="window.location.href='index.html'"> Continue Shopping</button>
    </div>

    <div class="invoice-box">
        <div class="header">
            <img src="${orderData.businessLogo}" class="logo" alt="${orderData.businessName} Logo">
            <div class="business-info">
                <h2>${orderData.businessName}</h2>
                <p style="margin:5px 0;">${orderData.businessEmail}</p>
                <p style="margin:5px 0;">${orderData.businessAddress}</p>
            </div>
        </div>

        <div class="details-grid">
            <div class="column">
                <h4>Billed To:</h4>
                <div style="font-size: 0.9em;">
                    <div>${orderData.name}</div>
                    <div>${orderData.addr}</div>
                    <div>${orderData.city}, ${orderData.zip}</div>
                    <div>${orderData.country}</div>
                    <div style="margin-top: 5px;">${orderData.email}</div>
                    <div>${orderData.phone}</div>
                </div>
            </div>
            <div class="column" style="text-align: right;">
                <h4>Invoice Details:</h4>
                <div style="font-size: 0.9em;">
                    <div><strong>Order ID:</strong> ${orderData.orderId}</div>
                    <div><strong>Order Date:</strong> ${orderData.orderDate}</div>
                    <div><strong>Payment Method:</strong> ${orderData.paymentMethod}</div>
                </div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                ${itemsHTML}
            </tbody>
        </table>

        <div class="totals-section">
            <div class="total-row">
                <span>Subtotal:</span>
                <span>${orderData.subtotal}</span>
            </div>
            <div class="total-row">
                <span>Shipping (${orderData.shippingMethod}):</span>
                <span>${orderData.shipping}</span>
            </div>
            <div class="total-row">
                <span>Service Fee:</span>
                <span>${orderData.fee}</span>
            </div>
            <div class="total-row grand-total">
                <span>TOTAL:</span>
                <span>${orderData.total}</span>
            </div>
            ${orderData.isCOD ? `
            <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; width: 100%;">
                <div class="total-row" style="color: #c9302c; font-weight: bold;">
                    <span>Due Today (33% Service Fee):</span>
                    <span>$${orderData.dueToday}</span>
                </div>
                <div class="total-row" style="color: #28a745; font-weight: bold;">
                    <span>Due on Delivery:</span>
                    <span>$${orderData.dueOnDelivery}</span>
                </div>
                <div style="font-size: 0.75em; color: #666; margin-top: 10px; font-style: italic;">
                    Service fee must be paid within 24 hours to confirm your COD order.
                </div>
            </div>
            ` : ''}
        </div>

        <div class="footer">
            <div>Thank you for your business!</div>
            <div style="margin-top: 10px;">${orderData.businessName} | ${orderData.businessEmail} | ${orderData.businessAddress}</div>
            <div style="margin-top: 10px; font-size: 0.7em; color: #aaa;">
                This is an automated invoice generated for order ${orderData.orderId}
            </div>
        </div>
    </div>
</body>
</html>`;
}
</script>
</body>
</html>



